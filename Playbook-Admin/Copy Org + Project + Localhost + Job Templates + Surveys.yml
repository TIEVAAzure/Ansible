---
# AWX â€“ Copy Job Templates + Surveys Between Orgs (Phase 1) - HYBRID CREDENTIALS
#
# Includes:
#  1) Ensure TARGET org exists
#  2) Ensure shared Project exists in TARGET org (duplicate per org, same repo/branch)
#  3) Ensure Localhost inventory + localhost host exists in TARGET org
#  4) Copy Job Templates from SOURCE org to TARGET org (uses shared project)
#  5) Copy Job Template Surveys
#
# HYBRID credential behaviour:
#  - Job Templates are copied even if target org is missing some credentials
#  - Only credentials that exist in the target org (matched by name) are attached
#  - Missing credential names are logged in the summary report (per template)
#
# sync_mode:
#  - true  = sync/update (destination JTs + surveys will be updated to match source)
#  - false = create-only (does not modify existing destination JTs/surveys)
#
# Dependencies checked for skip/fail:
#  - Inventory (if set on the JT)
#  - Execution Environment (if set on the JT)
# Credentials are NOT treated as hard dependencies in hybrid mode.

- name: "AWX: Copy Job Templates + Surveys (Hybrid creds)"
  hosts: localhost
  gather_facts: false

  collections:
    - awx.awx

  vars:
    # ===== Orgs =====
    source_org_name: "ORG-SOURCE"
    target_org_name: "ORG-TARGET"

    # ===== Shared Project (per-org duplicate) =====
    shared_project_name: "TIEVAAzure/Ansible"
    shared_project_scm_url: "https://github.com/TIEVAAzure/Ansible"
    shared_project_scm_branch: "main"

    # Repo is public for now - leave blank
    shared_project_scm_credential_name: ""

    # ===== Localhost inventory =====
    localhost_inventory_name: "Localhost"
    localhost_host_name: "localhost"
    localhost_host_vars:
      ansible_connection: "local"
      ansible_python_interpreter: "/usr/bin/python3"

    # ===== Copy behaviour =====
    sync_mode: true
    skip_templates_missing_deps: true
    page_size: 200

    # ===== Controller connection =====
    controller_host: "{{ lookup('env', 'CONTROLLER_HOST') | default(omit, true) }}"
    controller_username: "{{ lookup('env', 'CONTROLLER_USERNAME') | default(omit, true) }}"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') | default(omit, true) }}"
    controller_oauthtoken: "{{ lookup('env', 'CONTROLLER_OAUTH_TOKEN') | default(omit, true) }}"
    controller_validate_certs: false

  tasks:
    - name: Guard - ensure controller connection is available
      ansible.builtin.assert:
        that:
          - lookup('env', 'TOWER_HOST') or lookup('env', 'CONTROLLER_HOST')
          - lookup('env', 'TOWER_OAUTH_TOKEN') or lookup('env', 'CONTROLLER_OAUTH_TOKEN')
        fail_msg: >
          AWX controller connection details not found.
          Set TOWER_HOST/TOWER_OAUTH_TOKEN (preferred) or CONTROLLER_HOST/CONTROLLER_OAUTH_TOKEN
          in the Job Template environment variables.
    # -------------------------------------------------------------------------
    # Step 1: Ensure TARGET org exists
    # -------------------------------------------------------------------------
    - name: Ensure TARGET org exists
      awx.awx.organization:
        name: "{{ target_org_name }}"
        state: present
        controller_host: "{{ controller_host | default(omit) }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"

    # -------------------------------------------------------------------------
    # Resolve SOURCE org ID
    # -------------------------------------------------------------------------
    - name: Lookup SOURCE org by name
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "organizations"
        query_params:
          name: "{{ source_org_name }}"
      register: source_org_lookup

    - name: Fail if SOURCE org not found
      ansible.builtin.fail:
        msg: "SOURCE org '{{ source_org_name }}' not found in AWX."
      when: (source_org_lookup.json.count | default(0)) | int == 0

    - name: Set SOURCE org ID
      ansible.builtin.set_fact:
        source_org_id: "{{ source_org_lookup.json.results[0].id }}"

    # -------------------------------------------------------------------------
    # Step 2: Ensure shared Project exists in TARGET org
    # -------------------------------------------------------------------------
    - name: Ensure shared Project exists in TARGET org
      awx.awx.project:
        name: "{{ shared_project_name }}"
        organization: "{{ target_org_name }}"
        state: present
        scm_type: git
        scm_url: "{{ shared_project_scm_url }}"
        scm_branch: "{{ shared_project_scm_branch }}"
        scm_clean: true
        scm_delete_on_update: true
        scm_update_on_launch: true
        scm_credential: >-
          {{
            (shared_project_scm_credential_name | length) > 0
            | ternary(shared_project_scm_credential_name, omit)
          }}
        controller_host: "{{ controller_host | default(omit) }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"

    - name: Trigger project update (optional sanity check)
      awx.awx.project_update:
        project: "{{ shared_project_name }}"
        organization: "{{ target_org_name }}"
        wait: true
        timeout: 600
        controller_host: "{{ controller_host | default(omit) }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
      when: not ansible_check_mode

    # -------------------------------------------------------------------------
    # Step 3: Ensure Localhost inventory + host exists in TARGET org
    # -------------------------------------------------------------------------
    - name: Ensure Localhost inventory exists in TARGET org
      awx.awx.inventory:
        name: "{{ localhost_inventory_name }}"
        organization: "{{ target_org_name }}"
        state: present
        controller_host: "{{ controller_host | default(omit) }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"

    - name: Ensure localhost host exists in Localhost inventory
      awx.awx.host:
        name: "{{ localhost_host_name }}"
        inventory: "{{ localhost_inventory_name }}"
        state: present
        variables: "{{ localhost_host_vars | to_nice_yaml }}"
        controller_host: "{{ controller_host | default(omit) }}"
        controller_username: "{{ controller_username | default(omit) }}"
        controller_password: "{{ controller_password | default(omit) }}"
        controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"

    # -------------------------------------------------------------------------
    # Pre-flight: Build lookup name lists in TARGET org (inventories, creds, EEs)
    # -------------------------------------------------------------------------
    - name: Get TARGET inventories (first page)
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "inventories"
        query_params:
          organization: "{{ target_org_name }}"
          page_size: "{{ page_size }}"
          page: 1
      register: tgt_inventories_page1

    - name: Get TARGET credentials (first page)
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "credentials"
        query_params:
          organization: "{{ target_org_name }}"
          page_size: "{{ page_size }}"
          page: 1
      register: tgt_creds_page1

    - name: Get TARGET execution environments (first page)
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "execution_environments"
        query_params:
          page_size: "{{ page_size }}"
          page: 1
      register: tgt_ees_page1

    - name: Build TARGET lookup name lists
      ansible.builtin.set_fact:
        tgt_inventory_names: "{{ (tgt_inventories_page1.json.results | default([])) | map(attribute='name') | list }}"
        tgt_credential_names: "{{ (tgt_creds_page1.json.results | default([])) | map(attribute='name') | list }}"
        tgt_ee_names: "{{ (tgt_ees_page1.json.results | default([])) | map(attribute='name') | list }}"

    # -------------------------------------------------------------------------
    # Step 4: Pull Job Templates from SOURCE org
    # -------------------------------------------------------------------------
    - name: Get Job Templates (page 1) from SOURCE org
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "job_templates"
        query_params:
          organization: "{{ source_org_id }}"
          page_size: "{{ page_size }}"
          page: 1
      register: jt_page_1

    - name: Calculate total JT pages
      ansible.builtin.set_fact:
        jt_total_pages: "{{ ((jt_page_1.json.count | int) + (page_size | int) - 1) // (page_size | int) }}"
        jt_pages: "{{ range(1, ((((jt_page_1.json.count | int) + (page_size | int) - 1) // (page_size | int)) + 1)) | list }}"

    - name: Fetch remaining JT pages (if any)
      awx.awx.controller_api:
        host: "{{ controller_host | default(omit) }}"
        username: "{{ controller_username | default(omit) }}"
        password: "{{ controller_password | default(omit) }}"
        oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
        validate_certs: "{{ controller_validate_certs }}"
        method: GET
        endpoint: "job_templates"
        query_params:
          organization: "{{ source_org_id }}"
          page_size: "{{ page_size }}"
          page: "{{ item }}"
      loop: "{{ jt_pages }}"
      when: item != 1
      register: jt_other_pages

    - name: Combine Job Templates into one list
      ansible.builtin.set_fact:
        source_job_templates: >-
          {{
            (jt_page_1.json.results | default([]))
            +
            (
              jt_other_pages.results
              | default([])
              | map(attribute='json.results')
              | list
              | flatten
            )
          }}

    - name: Initialise copy report
      ansible.builtin.set_fact:
        jt_copied: []
        jt_skipped: []
        jt_surveys_applied: []
        jt_missing_creds: []   # <--- hybrid credential report

    # -------------------------------------------------------------------------
    # Copy JT + Survey (per template)
    # -------------------------------------------------------------------------
    - name: Copy Job Templates (and Surveys) into TARGET org - Hybrid creds
      vars:
        jt_name: "{{ item.name }}"
        src_inventory_name: "{{ item.summary_fields.inventory.name | default('') }}"
        src_ee_name: "{{ item.summary_fields.execution_environment.name | default('') }}"

        # Credentials on source JT
        src_cred_names: "{{ (item.summary_fields.credentials | default([])) | map(attribute='name') | list }}"

        # HYBRID: only attach creds that exist in target org
        creds_to_attach: "{{ src_cred_names | intersect(tgt_credential_names) }}"
        missing_creds: "{{ src_cred_names | difference(tgt_credential_names) }}"

        # Hard dependency checks (inventory + EE only)
        inv_ok: "{{ (src_inventory_name | length == 0) or (src_inventory_name in tgt_inventory_names) }}"
        ee_ok: "{{ (src_ee_name | length == 0) or (src_ee_name in tgt_ee_names) }}"
        deps_ok: "{{ inv_ok and ee_ok }}"

        skip_reason: >-
          {{
            (not inv_ok) | ternary('Missing inventory in target: ' ~ src_inventory_name, '')
            ~ ((not inv_ok and not ee_ok) | ternary(' | ', ''))
            ~ (not ee_ok) | ternary('Missing EE in target: ' ~ src_ee_name, '')
          }}
      block:
        - name: Fail fast if deps missing and skipping disabled
          ansible.builtin.fail:
            msg: "Cannot copy JT '{{ jt_name }}': {{ skip_reason }}"
          when:
            - (deps_ok | bool) == false
            - (skip_templates_missing_deps | bool) == false

        - name: Skip JT (record) if deps missing
          ansible.builtin.set_fact:
            jt_skipped: "{{ jt_skipped + [ {'name': jt_name, 'reason': skip_reason } ] }}"
          when:
            - (deps_ok | bool) == false
            - (skip_templates_missing_deps | bool) == true

        # Determine if JT already exists in target org (used for create-only mode)
        - name: Check if JT exists in TARGET org
          awx.awx.controller_api:
            host: "{{ controller_host | default(omit) }}"
            username: "{{ controller_username | default(omit) }}"
            password: "{{ controller_password | default(omit) }}"
            oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
            validate_certs: "{{ controller_validate_certs }}"
            method: GET
            endpoint: "job_templates"
            query_params:
              name: "{{ jt_name }}"
              organization: "{{ target_org_name }}"
          register: tgt_jt_lookup
          when: deps_ok | bool

        - name: Set JT exists flag
          ansible.builtin.set_fact:
            tgt_jt_exists: "{{ (tgt_jt_lookup.json.count | default(0) | int) > 0 }}"
          when: deps_ok | bool

        # Create/Update JT (sync mode OR if it doesn't exist yet)
        - name: Create/Update JT in TARGET org (hybrid creds)
          awx.awx.job_template:
            name: "{{ jt_name }}"
            organization: "{{ target_org_name }}"
            state: present

            # Force your shared project for standardisation
            project: "{{ shared_project_name }}"

            inventory: "{{ (src_inventory_name | length > 0) | ternary(src_inventory_name, omit) }}"
            execution_environment: "{{ (src_ee_name | length > 0) | ternary(src_ee_name, omit) }}"

            # HYBRID: attach only creds that exist in target org
            credentials: "{{ (creds_to_attach | length > 0) | ternary(creds_to_attach, omit) }}"

            playbook: "{{ item.playbook }}"
            description: "{{ item.description | default('') }}"
            job_type: "{{ item.job_type | default('run') }}"
            verbosity: "{{ item.verbosity | default(0) }}"
            fork_count: "{{ item.fork_count | default(0) }}"
            timeout: "{{ item.timeout | default(0) }}"
            become_enabled: "{{ item.become_enabled | default(false) }}"
            allow_simultaneous: "{{ item.allow_simultaneous | default(false) }}"
            extra_vars: "{{ item.extra_vars | default('') }}"

            # Ask-on-launch flags (kept as-is)
            ask_variables_on_launch: "{{ item.ask_variables_on_launch | default(false) }}"
            ask_limit_on_launch: "{{ item.ask_limit_on_launch | default(false) }}"
            ask_tags_on_launch: "{{ item.ask_tags_on_launch | default(false) }}"
            ask_skip_tags_on_launch: "{{ item.ask_skip_tags_on_launch | default(false) }}"
            ask_job_type_on_launch: "{{ item.ask_job_type_on_launch | default(false) }}"
            ask_inventory_on_launch: "{{ item.ask_inventory_on_launch | default(false) }}"
            ask_credential_on_launch: "{{ item.ask_credential_on_launch | default(false) }}"
            ask_execution_environment_on_launch: "{{ item.ask_execution_environment_on_launch | default(false) }}"
            ask_forks_on_launch: "{{ item.ask_forks_on_launch | default(false) }}"
            ask_timeout_on_launch: "{{ item.ask_timeout_on_launch | default(false) }}"
            ask_verbosity_on_launch: "{{ item.ask_verbosity_on_launch | default(false) }}"

            controller_host: "{{ controller_host | default(omit) }}"
            controller_username: "{{ controller_username | default(omit) }}"
            controller_password: "{{ controller_password | default(omit) }}"
            controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
            validate_certs: "{{ controller_validate_certs }}"
          when:
            - deps_ok | bool
            - (sync_mode | bool) or (not tgt_jt_exists | bool)
          register: jt_apply

        - name: Record JT copied/updated
          ansible.builtin.set_fact:
            jt_copied: "{{ jt_copied + [ jt_name ] }}"
          when:
            - deps_ok | bool
            - (sync_mode | bool) or (not tgt_jt_exists | bool)

        # Record missing creds in report (even if we created/updated or create-only skipped update)
        - name: Record missing creds (hybrid mode)
          ansible.builtin.set_fact:
            jt_missing_creds: "{{ jt_missing_creds + [ {'name': jt_name, 'missing_creds': missing_creds} ] }}"
          when:
            - deps_ok | bool
            - (missing_creds | length) > 0

        # ---- Survey copy ----
        - name: Get SOURCE survey spec for this JT
          awx.awx.controller_api:
            host: "{{ controller_host | default(omit) }}"
            username: "{{ controller_username | default(omit) }}"
            password: "{{ controller_password | default(omit) }}"
            oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
            validate_certs: "{{ controller_validate_certs }}"
            method: GET
            endpoint: "job_templates/{{ item.id }}/survey_spec/"
          register: src_survey
          when: deps_ok | bool

        - name: Apply survey to TARGET JT (sync mode OR JT newly created)
          awx.awx.job_template_survey:
            job_template: "{{ jt_name }}"
            organization: "{{ target_org_name }}"
            state: present
            survey_spec: "{{ src_survey.json }}"
            controller_host: "{{ controller_host | default(omit) }}"
            controller_username: "{{ controller_username | default(omit) }}"
            controller_password: "{{ controller_password | default(omit) }}"
            controller_oauthtoken: "{{ controller_oauthtoken | default(omit) }}"
            validate_certs: "{{ controller_validate_certs }}"
          when:
            - deps_ok | bool
            - src_survey.json is defined
            - src_survey.json.name is defined
            - (sync_mode | bool) or (not tgt_jt_exists | bool)
          register: survey_apply

        - name: Record survey applied
          ansible.builtin.set_fact:
            jt_surveys_applied: "{{ jt_surveys_applied + [ jt_name ] }}"
          when:
            - deps_ok | bool
            - src_survey.json is defined
            - src_survey.json.name is defined
            - (sync_mode | bool) or (not tgt_jt_exists | bool)

      loop: "{{ source_job_templates }}"
      loop_control:
        label: "{{ item.name }}"

    # -------------------------------------------------------------------------
    # Summary / reporting
    # -------------------------------------------------------------------------
    - name: Summary - Job Templates copied/updated
      ansible.builtin.debug:
        msg:
          - "sync_mode={{ sync_mode }} (true=sync/update, false=create-only)"
          - "Copied/Updated {{ jt_copied | length }} Job Templates into '{{ target_org_name }}'."
          - "Templates: {{ jt_copied }}"

    - name: Summary - Surveys applied
      ansible.builtin.debug:
        msg:
          - "Applied surveys to {{ jt_surveys_applied | length }} Job Templates."
          - "Survey templates: {{ jt_surveys_applied }}"

    - name: Summary - Skipped templates (missing deps)
      ansible.builtin.debug:
        msg:
          - "Skipped {{ jt_skipped | length }} Job Templates due to missing hard dependencies (inventory/EE)."
          - "Skipped detail: {{ jt_skipped }}"
      when: (jt_skipped | length) > 0

    - name: Summary - Missing credentials (hybrid report)
      ansible.builtin.debug:
        msg:
          - "Templates with missing credentials in target org: {{ jt_missing_creds | length }}"
          - "Missing creds detail: {{ jt_missing_creds }}"
      when: (jt_missing_creds | length) > 0