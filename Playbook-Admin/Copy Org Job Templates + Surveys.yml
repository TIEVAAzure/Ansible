---
- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, selectable, with Dry Run)"
  hosts: localhost
  gather_facts: false
  collections:
    - awx.awx

  vars:
    # ===== Survey-driven toggles =====
    # dry_run: true|false
    # copy_all_templates: true|false
    # template_include: "AZ – *,AVD*"
    # template_exclude: "Test*,Old*"
    # allow_only_localhost_inventory_mapping: true|false
    # create_templates_without_missing_creds: true|false

    # ===== Shared naming (must match your bootstrap naming) =====
    target_project_name: "{{ target_org_name }} - TIEVAAzure-Ansible"
    target_localhost_inventory_name: "{{ target_org_name }} - Localhost"

    # Source inventory name used in the MASTER templates
    source_localhost_inventory_name: "Localhost"

    # ===== Controller auth (set by your JT vars, not survey) =====
    controller_host: "{{ tower_host }}"
    controller_oauthtoken: "{{ tower_oauth_token }}"
    controller_validate_certs: "{{ (tower_verify_ssl | default(true)) | bool }}"

    # API base
    api_base: "{{ controller_host | regex_replace('/+$','') }}/api/v2"

    # HTTP headers
    api_headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
      Content-Type: "application/json"

  tasks:
    # ---------------------------------------------------------------------
    # Guards
    # ---------------------------------------------------------------------
    - name: Guard - controller vars present
      ansible.builtin.assert:
        that:
          - tower_host is defined and (tower_host | length > 0)
          - tower_oauth_token is defined and (tower_oauth_token | length > 0)
        fail_msg: "tower_host / tower_oauth_token not set on the Job Template."

    - name: Guard - org vars present
      ansible.builtin.assert:
        that:
          - source_org_name is defined and (source_org_name | length > 0)
          - target_org_name is defined and (target_org_name | length > 0)
        fail_msg: "source_org_name and target_org_name are required."

    - name: Guard - survey toggles present
      ansible.builtin.assert:
        that:
          - dry_run is defined
          - copy_all_templates is defined
          - allow_only_localhost_inventory_mapping is defined
          - create_templates_without_missing_creds is defined
        fail_msg: "Missing one or more survey toggles: dry_run, copy_all_templates, allow_only_localhost_inventory_mapping, create_templates_without_missing_creds."

    # ---------------------------------------------------------------------
    # Lookups via AWX API (uri) - no awx.awx.controller_api required
    # ---------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ api_base }}/organizations/?name={{ source_org_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: src_org_rsp

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ api_base }}/organizations/?name={{ target_org_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_org_rsp

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - (src_org_rsp.json.count | int) == 1
          - (dst_org_rsp.json.count | int) == 1
        fail_msg: "Expected exactly 1 result for source and target org. Check names / duplicates."

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ src_org_rsp.json.results[0].id }}"
        target_org_id: "{{ dst_org_rsp.json.results[0].id }}"

    - name: Lookup target project (bootstrap must have created it)
      ansible.builtin.uri:
        url: "{{ api_base }}/projects/?organization={{ target_org_id }}&name={{ target_project_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_proj_rsp

    - name: Guard - target project exists
      ansible.builtin.assert:
        that:
          - (dst_proj_rsp.json.count | int) == 1
        fail_msg: "Target project '{{ target_project_name }}' not found. Run bootstrap first or fix naming."

    - name: Lookup target Localhost inventory (bootstrap must have created it)
      ansible.builtin.uri:
        url: "{{ api_base }}/inventories/?organization={{ target_org_id }}&name={{ target_localhost_inventory_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_inv_rsp

    - name: Guard - target Localhost inventory exists
      ansible.builtin.assert:
        that:
          - (dst_inv_rsp.json.count | int) == 1
        fail_msg: "Target inventory '{{ target_localhost_inventory_name }}' not found. Run bootstrap first or fix naming."

    # Credentials in target org (for dependency check)
    - name: Fetch target org credentials
      ansible.builtin.uri:
        url: "{{ api_base }}/credentials/?organization={{ target_org_id }}&page_size=200"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_creds_rsp

    - name: Build target credential name list
      ansible.builtin.set_fact:
        target_cred_names: "{{ (dst_creds_rsp.json.results | default([])) | map(attribute='name') | list }}"

    # Fetch source job templates
    - name: Fetch source org job templates
      ansible.builtin.uri:
        url: "{{ api_base }}/job_templates/?organization={{ source_org_id }}&page_size=200"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: src_jt_rsp

    # ---------------------------------------------------------------------
        # ---------------------------------------------------------------------
    # Selection logic (survey-driven) - dash AND spacing normalised
    # ---------------------------------------------------------------------
    - name: Parse include/exclude lists into arrays
      ansible.builtin.set_fact:
        template_include_list: >-
          {{
            (template_include | default('') | string)
            | split(',')
            | map('trim')
            | reject('equalto','')
            | list
          }}
        template_exclude_list: >-
          {{
            (template_exclude | default('') | string)
            | split(',')
            | map('trim')
            | reject('equalto','')
            | list
          }}

    - name: Build list of available source template names (for troubleshooting)
      ansible.builtin.set_fact:
        available_template_names: "{{ (src_jt_rsp.json.results | default([])) | map(attribute='name') | list }}"

    - name: Select job templates from source list according to include/exclude rules (strong normalisation)
      vars:
        # Normalise any dash type and ANY spacing around it to " - "
        # Also collapse whitespace.
        name_norm: >-
          {{
            (item.name | string)
            | regex_replace('\\s*[–—-]\\s*', ' - ')
            | regex_replace('\\s+', ' ')
            | trim
          }}

        include_norm: >-
          {{
            template_include_list
            | map('regex_replace', '\\s*[–—-]\\s*', ' - ')
            | map('regex_replace', '\\s+', ' ')
            | map('trim')
            | list
          }}

        exclude_norm: >-
          {{
            template_exclude_list
            | map('regex_replace', '\\s*[–—-]\\s*', ' - ')
            | map('regex_replace', '\\s+', ' ')
            | map('trim')
            | list
          }}

        # Convert wildcard patterns to regex
        include_regexes: >-
          {{
            include_norm
            | map('regex_escape')
            | map('regex_replace', '\\\\*', '.*')
            | map('regex_replace', '^', '^')
            | map('regex_replace', '$', '$')
            | list
          }}

        exclude_regexes: >-
          {{
            exclude_norm
            | map('regex_escape')
            | map('regex_replace', '\\\\*', '.*')
            | map('regex_replace', '^', '^')
            | map('regex_replace', '$', '$')
            | list
          }}

        include_hit: >-
          {{
            (copy_all_templates | bool)
            or
            (
              (include_regexes | length) > 0
              and
              (
                include_regexes
                | select('match', name_norm)
                | list
                | length
              ) > 0
            )
          }}

        exclude_hit: >-
          {{
            (exclude_regexes | length) > 0
            and
            (
              exclude_regexes
              | select('match', name_norm)
              | list
              | length
            ) > 0
          }}

      ansible.builtin.set_fact:
        selected_jt_raw: "{{ (selected_jt_raw | default([])) + ([item] if (include_hit and not exclude_hit) else []) }}"
      loop: "{{ src_jt_rsp.json.results | default([]) }}"

    - name: Set selected template names (for reporting)
      ansible.builtin.set_fact:
        selected_template_names: "{{ (selected_jt_raw | default([])) | map(attribute='name') | list }}"

    - name: If selection is empty, print first 50 available template names (to help pick patterns)
      ansible.builtin.debug:
        msg:
          - "No templates matched selection."
          - "You used: copy_all_templates={{ copy_all_templates }}, include='{{ template_include | default('') }}', exclude='{{ template_exclude | default('') }}'"
          - "TIP: Try include 'AZ*,AVD*' to avoid dash/spacing issues entirely."
          - "First 50 available template names:"
          - "{{ available_template_names[:50] }}"
      when: (selected_jt_raw | default([]) | length) == 0

    - name: Guard - selection not empty
      ansible.builtin.assert:
        that:
          - (selected_jt_raw | length) > 0
        fail_msg: >
          No templates matched your selection.
          copy_all_templates={{ copy_all_templates }},
          include='{{ template_include | default('') }}',
          exclude='{{ template_exclude | default('') }}'.


    # ---------------------------------------------------------------------
    # Build a minimal plan summary (missing creds + inventory mapping)
    # ---------------------------------------------------------------------
    - name: Initialise reporting
      ansible.builtin.set_fact:
        plan_missing_creds: {}
        plan_inventory_not_mapped: []

    - name: Build summary for selected templates
      vars:
        src_inv_name: "{{ item.summary_fields.inventory.name | default('') }}"
        inv_is_localhost: "{{ src_inv_name == source_localhost_inventory_name }}"

        src_cred_names: "{{ (item.summary_fields.credentials | default([])) | map(attribute='name') | list }}"
        missing_cred_names: "{{ src_cred_names | reject('in', target_cred_names) | list }}"

      ansible.builtin.set_fact:
        plan_missing_creds: "{{ plan_missing_creds | combine( (missing_cred_names | length > 0) | ternary({ item.name: missing_cred_names }, {}), recursive=true ) }}"
        plan_inventory_not_mapped: >-
          {{
            plan_inventory_not_mapped +
            (
              (
                allow_only_localhost_inventory_mapping | bool and
                (src_inv_name | length > 0) and
                (not inv_is_localhost)
              )
              | ternary([item.name], [])
            )
          }}
      loop: "{{ selected_jt_raw | default([]) }}"

    # ---------------------------------------------------------------------
    # DRY RUN reporting (names only)
    # ---------------------------------------------------------------------
    - name: Report summary
      ansible.builtin.debug:
        msg:
          - "DRY RUN = {{ dry_run }}"
          - "Source org: {{ source_org_name }}"
          - "Target org: {{ target_org_name }}"
          - "Target project: {{ target_project_name }}"
          - "Target inventory: {{ target_localhost_inventory_name }}"
          - "Selected templates: {{ selected_template_names | length }}"
          - "Templates with missing creds: {{ plan_missing_creds | length }}"
          - "Templates with inventory NOT mapped (phase 2): {{ plan_inventory_not_mapped | length }}"

    - name: List selected template names (dry run or apply)
      ansible.builtin.debug:
        msg: "{{ selected_template_names }}"

    - name: DRY RUN - show missing creds map (only if present)
      ansible.builtin.debug:
        var: plan_missing_creds
      when:
        - dry_run | bool
        - (plan_missing_creds | length) > 0

    - name: DRY RUN - show inventory not mapped list (only if present)
      ansible.builtin.debug:
        msg: "{{ plan_inventory_not_mapped }}"
      when:
        - dry_run | bool
        - (plan_inventory_not_mapped | length) > 0

    # ---------------------------------------------------------------------
    # Apply changes (only when dry_run=false)
    # ---------------------------------------------------------------------
    - name: Copy selected job templates into target org (apply)
      vars:
        src_inv_name: "{{ item.summary_fields.inventory.name | default('') }}"
        inv_is_localhost: "{{ src_inv_name == source_localhost_inventory_name }}"

        src_cred_names: "{{ (item.summary_fields.credentials | default([])) | map(attribute='name') | list }}"
        missing_cred_names: "{{ src_cred_names | reject('in', target_cred_names) | list }}"

        should_omit_inventory: >-
          {{
            allow_only_localhost_inventory_mapping | bool
            and (src_inv_name | length > 0)
            and (not inv_is_localhost)
          }}

        mapped_inventory_name: >-
          {{
            inv_is_localhost
            | ternary(target_localhost_inventory_name, omit)
          }}

        # Credentials:
        # - If any missing => omit (create template anyway if create_templates_without_missing_creds=true)
        # - If none missing => attach by NAME
        creds_to_attach: >-
          {{
            ((missing_cred_names | length) == 0)
            | ternary(src_cred_names, omit)
          }}

      awx.awx.job_template:
        name: "{{ item.name }}"
        description: "{{ item.description | default('') }}"
        organization: "{{ target_org_name }}"
        state: present

        # Force onto bootstrap project
        project: "{{ target_project_name }}"
        playbook: "{{ item.playbook }}"

        # Inventory mapping: only map Localhost; omit others
        inventory: "{{ (should_omit_inventory | bool) | ternary(omit, mapped_inventory_name) }}"

        # Execution Environment (global EE by name if present)
        execution_environment: "{{ item.summary_fields.execution_environment.name | default(omit) }}"

        # Core flags
        job_type: "{{ item.job_type | default('run') }}"
        become_enabled: "{{ item.become_enabled | default(false) }}"
        diff_mode: "{{ item.diff_mode | default(false) }}"
        allow_simultaneous: "{{ item.allow_simultaneous | default(false) }}"

        # Ask-on-launch flags
        ask_credential_on_launch: "{{ item.ask_credential_on_launch | default(false) }}"
        ask_inventory_on_launch: "{{ item.ask_inventory_on_launch | default(false) }}"
        ask_variables_on_launch: "{{ item.ask_variables_on_launch | default(false) }}"
        ask_limit_on_launch: "{{ item.ask_limit_on_launch | default(false) }}"
        ask_tags_on_launch: "{{ item.ask_tags_on_launch | default(false) }}"
        ask_skip_tags_on_launch: "{{ item.ask_skip_tags_on_launch | default(false) }}"
        ask_job_type_on_launch: "{{ item.ask_job_type_on_launch | default(false) }}"
        ask_verbosity_on_launch: "{{ item.ask_verbosity_on_launch | default(false) }}"
        ask_diff_mode_on_launch: "{{ item.ask_diff_mode_on_launch | default(false) }}"

        # Vars/tags/limits
        extra_vars: "{{ item.extra_vars | default(omit) }}"
        job_tags: "{{ item.job_tags | default('') }}"
        skip_tags: "{{ item.skip_tags | default('') }}"
        limit: "{{ item.limit | default('') }}"
        verbosity: "{{ item.verbosity | default(0) }}"

        # Surveys
        survey_enabled: "{{ item.survey_enabled | default(false) }}"
        survey_spec: "{{ item.survey_spec | default(omit) }}"

        # Credential attach behaviour
        credentials: "{{ creds_to_attach }}"

        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"

      loop: "{{ selected_jt_raw | default([]) }}"
      when:
        - not (dry_run | bool)
        - create_templates_without_missing_creds | bool or ((missing_cred_names | length) == 0)

    - name: Apply summary (only when dry_run=false)
      ansible.builtin.debug:
        msg:
          - "APPLY complete."
          - "Templates selected: {{ selected_template_names | length }}"
          - "Missing creds (logged): {{ plan_missing_creds | length }}"
          - "Inventory not mapped (logged): {{ plan_inventory_not_mapped | length }}"
      when: not (dry_run | bool)