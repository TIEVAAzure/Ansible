---
- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, with Dry Run)"
  hosts: localhost
  gather_facts: false
  collections:
    - awx.awx

  vars:
    # ====== DRY RUN ======
    # true  = no changes, just report what would happen
    # false = perform the copy
    dry_run: true

    # ====== Required survey vars ======
    # source_org_name: "Master"
    # target_org_name: "ORG_test"

    # ===== Shared naming (must match your bootstrap naming) =====
    target_project_name: "{{ target_org_name }} - TIEVAAzure-Ansible"
    target_localhost_inventory_name: "{{ target_org_name }} - Localhost"

    # Source inventory name used in the MASTER templates
    source_localhost_inventory_name: "Localhost"

    # Behaviour toggles (survey)
    allow_only_localhost_inventory_mapping: true
    create_templates_without_missing_creds: true

    # ===== Controller auth (you said these are already set by vars) =====
    controller_host: "{{ tower_host }}"
    controller_oauthtoken: "{{ tower_oauth_token }}"
    controller_validate_certs: "{{ (tower_verify_ssl | default(true)) | bool }}"

    # API base
    api_base: "{{ controller_host | regex_replace('/+$','') }}/api/v2"

    # HTTP headers
    api_headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
      Content-Type: "application/json"

  tasks:
    # ---------------------------------------------------------------------
    # Guards
    # ---------------------------------------------------------------------
    - name: Guard - controller vars present
      ansible.builtin.assert:
        that:
          - tower_host is defined and (tower_host | length > 0)
          - tower_oauth_token is defined and (tower_oauth_token | length > 0)
        fail_msg: "tower_host / tower_oauth_token not set."

    - name: Guard - org vars present
      ansible.builtin.assert:
        that:
          - source_org_name is defined and (source_org_name | length > 0)
          - target_org_name is defined and (target_org_name | length > 0)
        fail_msg: "source_org_name and target_org_name are required."

    # ---------------------------------------------------------------------
    # Lookups via AWX API (uri) - no awx.awx.controller_api required
    # ---------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ api_base }}/organizations/?name={{ source_org_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: src_org_rsp

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ api_base }}/organizations/?name={{ target_org_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_org_rsp

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - (src_org_rsp.json.count | int) == 1
          - (dst_org_rsp.json.count | int) == 1
        fail_msg: "Expected exactly 1 result for source and target org. Check names / duplicates."

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ src_org_rsp.json.results[0].id }}"
        target_org_id: "{{ dst_org_rsp.json.results[0].id }}"

    - name: Lookup target project (bootstrap must have created it)
      ansible.builtin.uri:
        url: "{{ api_base }}/projects/?organization={{ target_org_id }}&name={{ target_project_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_proj_rsp

    - name: Guard - target project exists
      ansible.builtin.assert:
        that:
          - (dst_proj_rsp.json.count | int) == 1
        fail_msg: "Target project '{{ target_project_name }}' not found. Run bootstrap first or fix naming."

    - name: Lookup target Localhost inventory (bootstrap must have created it)
      ansible.builtin.uri:
        url: "{{ api_base }}/inventories/?organization={{ target_org_id }}&name={{ target_localhost_inventory_name | urlencode }}"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_inv_rsp

    - name: Guard - target Localhost inventory exists
      ansible.builtin.assert:
        that:
          - (dst_inv_rsp.json.count | int) == 1
        fail_msg: "Target inventory '{{ target_localhost_inventory_name }}' not found. Run bootstrap first or fix naming."

    # Credentials in target org (for dependency check)
    - name: Fetch target org credentials
      ansible.builtin.uri:
        url: "{{ api_base }}/credentials/?organization={{ target_org_id }}&page_size=200"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: dst_creds_rsp

    - name: Build target credential name list
      ansible.builtin.set_fact:
        target_cred_names: "{{ (dst_creds_rsp.json.results | default([])) | map(attribute='name') | list }}"

    # Fetch source job templates
    - name: Fetch source org job templates
      ansible.builtin.uri:
        url: "{{ api_base }}/job_templates/?organization={{ source_org_id }}&page_size=200"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: "{{ controller_validate_certs }}"
        return_content: true
      register: src_jt_rsp

    - name: Initialise reporting
      ansible.builtin.set_fact:
        plan_templates: []
        plan_missing_creds: {}
        plan_inventory_not_mapped: []

    # ---------------------------------------------------------------------
    # Build a plan (always runs, even in dry_run)
    # ---------------------------------------------------------------------
    - name: Build copy plan
      vars:
        src_inv_name: "{{ item.summary_fields.inventory.name | default('') }}"
        inv_is_localhost: "{{ src_inv_name == source_localhost_inventory_name }}"

        src_cred_names: "{{ (item.summary_fields.credentials | default([])) | map(attribute='name') | list }}"
        missing_cred_names: "{{ src_cred_names | reject('in', target_cred_names) | list }}"

        mapped_inventory_name: >-
          {{
            inv_is_localhost
            | ternary(target_localhost_inventory_name, '')
          }}

      ansible.builtin.set_fact:
        plan_templates: "{{ plan_templates + [ {
          'name': item.name,
          'playbook': item.playbook,
          'source_inventory': src_inv_name,
          'mapped_inventory': mapped_inventory_name,
          'source_creds': src_cred_names,
          'missing_creds': missing_cred_names,
          'survey_enabled': (item.survey_enabled | default(false)),
          'has_survey_spec': (item.survey_spec is defined)
        } ] }}"
        plan_missing_creds: "{{ plan_missing_creds | combine( (missing_cred_names | length > 0) | ternary({ item.name: missing_cred_names }, {}), recursive=true ) }}"
        plan_inventory_not_mapped: >-
          {{
            plan_inventory_not_mapped +
            (
              (
                allow_only_localhost_inventory_mapping | bool and
                (src_inv_name | length > 0) and
                (not inv_is_localhost)
              )
              | ternary([item.name], [])
            )
          }}
      loop: "{{ src_jt_rsp.json.results | default([]) }}"

    - name: DRY RUN - report what will be copied
      ansible.builtin.debug:
        msg:
          - "DRY RUN = {{ dry_run }}"
          - "Source org: {{ source_org_name }} (id={{ source_org_id }})"
          - "Target org: {{ target_org_name }} (id={{ target_org_id }})"
          - "Target project: {{ target_project_name }}"
          - "Target inventory: {{ target_localhost_inventory_name }}"
          - "Templates found in source: {{ plan_templates | length }}"
          - "Templates with missing creds: {{ plan_missing_creds | length }}"
          - "Templates with inventory NOT mapped (phase 2): {{ plan_inventory_not_mapped | length }}"

    - name: DRY RUN - list template plan (names + key mapping)
      ansible.builtin.debug:
        var: plan_templates
      when: dry_run | bool

    # ---------------------------------------------------------------------
    # Apply changes (only when dry_run=false)
    # ---------------------------------------------------------------------
    - name: Copy job templates into target org (apply)
      vars:
        src_inv_name: "{{ item.summary_fields.inventory.name | default('') }}"
        inv_is_localhost: "{{ src_inv_name == source_localhost_inventory_name }}"
        src_cred_names: "{{ (item.summary_fields.credentials | default([])) | map(attribute='name') | list }}"
        missing_cred_names: "{{ src_cred_names | reject('in', target_cred_names) | list }}"

        mapped_inventory_name: >-
          {{
            inv_is_localhost
            | ternary(target_localhost_inventory_name, omit)
          }}

        should_omit_inventory: >-
          {{
            allow_only_localhost_inventory_mapping | bool
            and (src_inv_name | length > 0)
            and (not inv_is_localhost)
          }}

        # Attach creds only if none missing, else omit
        creds_to_attach: >-
          {{
            ((missing_cred_names | length) == 0)
            | ternary(src_cred_names, omit)
          }}

      awx.awx.job_template:
        name: "{{ item.name }}"
        description: "{{ item.description | default('') }}"
        organization: "{{ target_org_name }}"
        state: present

        # Force onto bootstrap project
        project: "{{ target_project_name }}"
        playbook: "{{ item.playbook }}"

        # Inventory mapping: only map Localhost; omit others
        inventory: "{{ (should_omit_inventory | bool) | ternary(omit, mapped_inventory_name) }}"

        # Execution Environment (global EE by name if present)
        execution_environment: "{{ item.summary_fields.execution_environment.name | default(omit) }}"

        # Core flags
        job_type: "{{ item.job_type | default('run') }}"
        become_enabled: "{{ item.become_enabled | default(false) }}"
        diff_mode: "{{ item.diff_mode | default(false) }}"
        allow_simultaneous: "{{ item.allow_simultaneous | default(false) }}"

        # Ask-on-launch flags
        ask_credential_on_launch: "{{ item.ask_credential_on_launch | default(false) }}"
        ask_inventory_on_launch: "{{ item.ask_inventory_on_launch | default(false) }}"
        ask_variables_on_launch: "{{ item.ask_variables_on_launch | default(false) }}"
        ask_limit_on_launch: "{{ item.ask_limit_on_launch | default(false) }}"
        ask_tags_on_launch: "{{ item.ask_tags_on_launch | default(false) }}"
        ask_skip_tags_on_launch: "{{ item.ask_skip_tags_on_launch | default(false) }}"
        ask_job_type_on_launch: "{{ item.ask_job_type_on_launch | default(false) }}"
        ask_verbosity_on_launch: "{{ item.ask_verbosity_on_launch | default(false) }}"
        ask_diff_mode_on_launch: "{{ item.ask_diff_mode_on_launch | default(false) }}"

        # Vars/tags/limits
        extra_vars: "{{ item.extra_vars | default(omit) }}"
        job_tags: "{{ item.job_tags | default('') }}"
        skip_tags: "{{ item.skip_tags | default('') }}"
        limit: "{{ item.limit | default('') }}"
        verbosity: "{{ item.verbosity | default(0) }}"

        # Surveys
        survey_enabled: "{{ item.survey_enabled | default(false) }}"
        survey_spec: "{{ item.survey_spec | default(omit) }}"

        # Credentials behaviour:
        # - If creds missing => omit (template still created)
        # - If none missing => attach by NAME
        credentials: "{{ creds_to_attach }}"

        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ src_jt_rsp.json.results | default([]) }}"
      when:
        - not (dry_run | bool)
        - create_templates_without_missing_creds | bool or ((src_cred_names | reject('in', target_cred_names) | list) | length) == 0

    - name: Apply summary (only when dry_run=false)
      ansible.builtin.debug:
        msg:
          - "APPLY complete."
          - "Templates processed: {{ src_jt_rsp.json.count | default(0) }}"
          - "Missing creds (logged): {{ plan_missing_creds | length }}"
          - "Inventory not mapped (logged): {{ plan_inventory_not_mapped | length }}"
      when: not (dry_run | bool)