---
# ============================================================================
# Playbook: Copy Org Job Templates + Surveys (Bootstrap-aware)
#
# Purpose:
#   - Copy Job Templates from a source AWX org to a target AWX org
#   - Optionally copy Survey Specs
#   - Optionally attach Credentials (by name match)
#
# Key design points:
#   - URI-only (ansible.builtin.uri). NO awx.awx / tower_* modules required.
#   - Bootstrap-aligned defaults:
#       * target_project_name defaults to target_org_name
#       * target_localhost_inventory_name defaults to "<target_org_name> - Localhost"
#   - Selection via include/exclude wildcard patterns (* and ?) or "copy_all_templates"
#
# Required companion file (same directory in repo):
#   - _copy_one_template.yml
# ============================================================================

- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware) [URI-only]"
  hosts: localhost
  gather_facts: false

  vars:
    # ------------------------------------------------------------------------
    # Controller connection (provided by AWX Job Template 'Variables')
    #
    # Your template variables already contain:
    #   tower_host: "https://<controller>"
    #   tower_oauth_token: "<token>"
    #   tower_verify_ssl: true/false
    #
    # IMPORTANT:
    #   Do not try to "redefine" tower_* here.
    # ------------------------------------------------------------------------
    tower_verify_ssl: "{{ tower_verify_ssl | default(true) | bool }}"

    # Normalise API base to https://host/api/v2 (strip trailing slashes)
    awx_api_base: >-
      {{
        (tower_host | default('') | string | trim | regex_replace('/+$',''))
        ~ '/api/v2'
      }}

    awx_headers:
      Authorization: "Bearer {{ tower_oauth_token }}"
      Content-Type: "application/json"

    # Behaviour toggles (normally Survey-driven)
    dry_run: "{{ dry_run | default(false) | bool }}"
    debug_mode: "{{ debug_mode | default(false) | bool }}"

    # If true, only map templates that use the "source_localhost_inventory_name"
    # inventory; all other inventories are left unmapped (and logged).
    allow_only_localhost_inventory_mapping: "{{ allow_only_localhost_inventory_mapping | default(true) | bool }}"

    # If true, templates will still be created/updated even if some credentials
    # referenced by the source template do not exist in the target org.
    create_templates_without_missing_creds: "{{ create_templates_without_missing_creds | default(true) | bool }}"

    # Selection inputs
    copy_all_templates: "{{ copy_all_templates | default(false) | bool }}"
    template_include: "{{ template_include | default('') | string }}"
    template_exclude: "{{ template_exclude | default('') | string }}"

    # ------------------------------------------------------------------------
    # Bootstrap-aligned defaults (KEEP CONSISTENT WITH BOOTSTRAP PLAYBOOK)
    # ------------------------------------------------------------------------
    # Bootstrap creates:
    #   - Org:       target_org_name
    #   - Project:   target_org_name
    #   - Inventory: "<target_org_name> - Localhost"
    target_project_name: "{{ target_project_name | default(target_org_name) }}"
    target_localhost_inventory_name: "{{ target_localhost_inventory_name | default(target_org_name ~ ' - Localhost') }}"

    # What inventory name the MASTER templates use for localhost (adjust if needed)
    source_localhost_inventory_name: "{{ source_localhost_inventory_name | default('Master - Localhost') }}"

    # Paging
    page_size: 200

  tasks:
    - name: Guard - ensure controller connection is configured
      ansible.builtin.assert:
        that:
          - tower_host is defined and (tower_host | string | length > 0)
          - tower_oauth_token is defined and (tower_oauth_token | string | length > 0)
        fail_msg: >
          Missing controller connection details. Ensure the AWX Job Template Variables include
          tower_host and tower_oauth_token.

    - name: Guard - ensure org inputs are present
      ansible.builtin.assert:
        that:
          - source_org_name is defined and (source_org_name | string | length > 0)
          - target_org_name is defined and (target_org_name | string | length > 0)
        fail_msg: >
          You must provide source_org_name and target_org_name (Survey / extra vars).

    - name: Debug - show resolved controller inputs
      ansible.builtin.debug:
        msg:
          - "awx_api_base={{ awx_api_base }}"
          - "tower_verify_ssl={{ tower_verify_ssl }}"
          - "source_org_name={{ source_org_name }}"
          - "target_org_name={{ target_org_name }}"
          - "target_project_name={{ target_project_name }}"
          - "source_localhost_inventory_name={{ source_localhost_inventory_name }}"
          - "target_localhost_inventory_name={{ target_localhost_inventory_name }}"
          - "copy_all_templates={{ copy_all_templates }}"
          - "template_include={{ template_include }}"
          - "template_exclude={{ template_exclude }}"
          - "dry_run={{ dry_run }}"
      when: debug_mode | bool

    # ------------------------------------------------------------------------
    # Lookups: org IDs
    # ------------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ source_org_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: src_org_rsp

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ target_org_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: dst_org_rsp

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - (src_org_rsp.json.count | int) == 1
          - (dst_org_rsp.json.count | int) == 1
        fail_msg: >
          Expected exactly 1 org result for both source and target.
          Check org names (duplicates?) and try again.

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ src_org_rsp.json.results[0].id }}"
        target_org_id: "{{ dst_org_rsp.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Lookups: target project (bootstrap created it with name == target_org_name)
    # ------------------------------------------------------------------------
    - name: Lookup target project by org + name
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/projects/?organization={{ target_org_id }}&name={{ target_project_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: dst_project_rsp

    - name: Guard - target project exists (bootstrap must run first)
      ansible.builtin.assert:
        that:
          - (dst_project_rsp.json.count | int) == 1
        fail_msg: >
          Target project '{{ target_project_name }}' not found in org '{{ target_org_name }}'.
          Run the bootstrap playbook first or fix naming.

    - name: Set target project ID
      ansible.builtin.set_fact:
        target_project_id: "{{ dst_project_rsp.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Lookups: target localhost inventory (bootstrap created it)
    # ------------------------------------------------------------------------
    - name: Lookup target localhost inventory by org + name
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/inventories/?organization={{ target_org_id }}&name={{ target_localhost_inventory_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: dst_local_inv_rsp

    - name: Guard - target localhost inventory exists (bootstrap must run first)
      ansible.builtin.assert:
        that:
          - (dst_local_inv_rsp.json.count | int) == 1
        fail_msg: >
          Target inventory '{{ target_localhost_inventory_name }}' not found in org '{{ target_org_name }}'.
          Run the bootstrap playbook first or fix naming.

    - name: Set target localhost inventory ID
      ansible.builtin.set_fact:
        target_localhost_inventory_id: "{{ dst_local_inv_rsp.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Preload target org credentials (map name -> id)
    # ------------------------------------------------------------------------
    - name: Fetch credentials in target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/credentials/?organization={{ target_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: dst_creds_rsp

    - name: Guard - credentials pagination not required (page_size={{ page_size }})
      ansible.builtin.assert:
        that:
          - dst_creds_rsp.json.next is none
        fail_msg: >
          Target org has more than {{ page_size }} credentials and requires pagination.
          Increase page_size or add pagination logic.

    - name: Build target credential name->id map
      ansible.builtin.set_fact:
        dst_cred_map: >-
          {{
            dict(
              (dst_creds_rsp.json.results | default([]))
              | map(attribute='name')
              | zip((dst_creds_rsp.json.results | default([])) | map(attribute='id'))
            )
          }}

    # ------------------------------------------------------------------------
    # Fetch source org job templates
    # ------------------------------------------------------------------------
    - name: Fetch job templates in source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/?organization={{ source_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: src_jt_rsp

    - name: Guard - templates pagination not required (page_size={{ page_size }})
      ansible.builtin.assert:
        that:
          - src_jt_rsp.json.next is none
        fail_msg: >
          Source org has more than {{ page_size }} templates and requires pagination.
          Increase page_size or add pagination logic.

    # ------------------------------------------------------------------------
    # Selection logic
    # ------------------------------------------------------------------------
    - name: Parse include/exclude patterns (comma-separated)
      ansible.builtin.set_fact:
        include_patterns: >-
          {{
            (template_include | string)
            | split(',')
            | map('trim')
            | reject('equalto', '')
            | list
          }}
        exclude_patterns: >-
          {{
            (template_exclude | string)
            | split(',')
            | map('trim')
            | reject('equalto', '')
            | list
          }}

    - name: Build include/exclude regex (from wildcards)
      ansible.builtin.set_fact:
        include_combined: >-
          {{
            (
              ((include_patterns | length) > 0)
              | ternary(
                  '^(?:' ~ (
                    include_patterns
                    | map('regex_escape')
                    | map('regex_replace', '\\*', '.*')
                    | map('regex_replace', '\\?', '.')
                    | join('|')
                  ) ~ ')$',
                  '.*'
                )
            )
          }}
        exclude_combined: >-
          {{
            (
              ((exclude_patterns | length) > 0)
              | ternary(
                  '^(?:' ~ (
                    exclude_patterns
                    | map('regex_escape')
                    | map('regex_replace', '\\*', '.*')
                    | map('regex_replace', '\\?', '.')
                    | join('|')
                  ) ~ ')$',
                  'a^'
                )
            )
          }}

    - name: Select templates
      ansible.builtin.set_fact:
        selected_templates: >-
          {{
            (src_jt_rsp.json.results | default([]))
            | selectattr('name', 'defined')
            | selectattr('name', 'match', (copy_all_templates | bool) | ternary('.*', include_combined))
            | rejectattr('name', 'match', exclude_combined)
            | list
          }}

    - name: Guard - at least one template selected
      ansible.builtin.assert:
        that:
          - (selected_templates | length) > 0
        fail_msg: >
          No templates selected. Check include/exclude patterns or set copy_all_templates=true.

    - name: Dry run - stop after selection
      ansible.builtin.meta: end_play
      when: dry_run | bool

    # ------------------------------------------------------------------------
    # Fetch details + survey specs, then loop include_tasks (legal pattern)
    # ------------------------------------------------------------------------
    - name: Fetch full detail for each selected template
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_details

    - name: Fetch survey spec for each selected template (200 or 404)
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/survey_spec/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
        status_code: [200, 404]
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_surveys

    - name: Build work list (detail + survey paired)
      ansible.builtin.set_fact:
        templates_work: "{{ jt_details.results | zip(jt_surveys.results) | list }}"

    - name: Initialise tracking
      ansible.builtin.set_fact:
        copied_templates: []
        skipped_templates: []
        templates_missing_creds: {}
        templates_inventory_not_mapped: []

    - name: Copy templates into target org (create/update + survey + creds)
      ansible.builtin.include_tasks: "_copy_one_template.yml"
      loop: "{{ templates_work }}"
      loop_control:
        label: "{{ item.0.json.name }}"

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "Copied: {{ copied_templates | length }} -> {{ copied_templates }}"
          - "Skipped: {{ skipped_templates | length }} -> {{ skipped_templates }}"
          - "Missing creds: {{ templates_missing_creds }}"
          - "Inventory not mapped: {{ templates_inventory_not_mapped }}"
