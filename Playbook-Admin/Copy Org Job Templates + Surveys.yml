---
# ============================================================================
# Playbook: Copy Org Job Templates + Surveys (Bootstrap-aware) [URI-only]
#
# Purpose:
#   - Copy Job Templates from one AWX org to another
#   - Optionally copy Survey Specs and (if possible) Credentials
#
# Constraints:
#   - Uses ONLY built-in Ansible modules (ansible.builtin.*)
#   - Does NOT use awx.awx / tower_* modules/collections
#
# Companion file required (same directory):
#   - _copy_one_template.yml
# ============================================================================

- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, Selection + Dry Run) [URI-only]"
  hosts: localhost
  gather_facts: false

  # IMPORTANT:
  # Do NOT redefine tower_host / tower_oauth_token / tower_verify_ssl here.
  # AWX injects them from the Job Template variables.

  vars:
    # Defaults
    awx_api_base_default: "https://tievaawx01.uksouth.cloudapp.azure.com"
    page_size: 200

    # Inputs (read from AWX job template / survey; do not self-reference internal vars)
    awx_api_base_input: "{{ (tower_host | default('')) }}"
    awx_token_input: "{{ (tower_oauth_token | default('')) }}"
    verify_ssl_input: "{{ (tower_verify_ssl | default(true)) }}"

    copy_all_templates_input: "{{ (copy_all_templates | default(false)) }}"
    template_include_input: "{{ (template_include | default('')) }}"
    template_exclude_input: "{{ (template_exclude | default('')) }}"
    dry_run_input: "{{ (dry_run | default(false)) }}"
    debug_mode_input: "{{ (debug_mode | default(false)) }}"

  tasks:
    # ------------------------------------------------------------------------
    # Normalise connection + flags (NO empty set_fact possible)
    # ------------------------------------------------------------------------
    - name: Normalise controller connection variables + flags
      ansible.builtin.set_fact:
        tower_verify_ssl: "{{ verify_ssl_input | bool }}"
        awx_token: "{{ awx_token_input | string }}"
        copy_all_templates: "{{ copy_all_templates_input | bool }}"
        template_include: "{{ template_include_input | string }}"
        template_exclude: "{{ template_exclude_input | string }}"
        dry_run: "{{ dry_run_input | bool }}"
        debug_mode: "{{ debug_mode_input | bool }}"
        awx_api_base: >-
          {{
            (
              (
                awx_api_base_input
                if (awx_api_base_input is string and awx_api_base_input | length > 0)
                else awx_api_base_default
              )
              | regex_replace('/+$', '')
            )
            ~ (
              '/api/v2'
              if (
                (
                  (
                    awx_api_base_input
                    if (awx_api_base_input is string and awx_api_base_input | length > 0)
                    else awx_api_base_default
                  )
                  | regex_replace('/+$', '')
                ) is not search('/api/v2$')
              )
              else ''
            )
          }}

    - name: Guard - ensure required inputs are present
      ansible.builtin.assert:
        that:
          - awx_api_base is string
          - awx_api_base | length > 0
          - awx_token is string
          - awx_token | length > 0
          - source_org_name is defined
          - target_org_name is defined
        fail_msg: "Missing/invalid tower_host/tower_oauth_token or source_org_name/target_org_name"

    - name: Set common AWX headers
      ansible.builtin.set_fact:
        awx_headers:
          Authorization: "Bearer {{ awx_token }}"
          Content-Type: "application/json"

    - name: Initialise tracking (for include file)
      ansible.builtin.set_fact:
        copied_templates: []
        skipped_templates: []
        templates_missing_creds: {}
        templates_inventory_not_mapped: []

    - name: Debug - show resolved controller inputs
      ansible.builtin.debug:
        msg:
          - "awx_api_base={{ awx_api_base }}"
          - "tower_verify_ssl={{ tower_verify_ssl }}"
          - "copy_all_templates={{ copy_all_templates }}"
          - "template_include='{{ template_include }}'"
          - "template_exclude='{{ template_exclude }}'"
          - "dry_run={{ dry_run }}"
      when: debug_mode

    # ------------------------------------------------------------------------
    # Lookup org IDs
    # ------------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ source_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_org

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ target_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: target_org

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - source_org.json.count == 1
          - target_org.json.count == 1
        fail_msg: "Org lookup did not return exactly one result for source/target"

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ source_org.json.results[0].id }}"
        target_org_id: "{{ target_org.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Target bootstrap lookups (project / localhost inventory / creds map)
    # NOTE: if these arenâ€™t part of your process yet, these tasks make the
    # include file variables exist and prevent undefined-var crashes.
    # ------------------------------------------------------------------------
    - name: Lookup target project by name
      ansible.builtin.assert:
        that:
          - target_project_name is defined
        fail_msg: "You must provide target_project_name (survey/extra var)."
    - name: Get target project id
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/projects/?organization={{ target_org_id }}&name={{ target_project_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: tgt_proj

    - name: Guard - target project found
      ansible.builtin.assert:
        that:
          - tgt_proj.json.count == 1
        fail_msg: "Target project not found (check target_project_name)."

    - name: Set target_project_id
      ansible.builtin.set_fact:
        target_project_id: "{{ tgt_proj.json.results[0].id }}"

    - name: Default localhost inventory names (override via vars if you want)
      ansible.builtin.set_fact:
        source_localhost_inventory_name: "{{ source_localhost_inventory_name | default('Master - Localhost') }}"
        target_localhost_inventory_name: "{{ target_localhost_inventory_name | default('Master - Localhost') }}"
        allow_only_localhost_inventory_mapping: "{{ allow_only_localhost_inventory_mapping | default(true) | bool }}"
        create_templates_without_missing_creds: "{{ create_templates_without_missing_creds | default(true) | bool }}"

    - name: Lookup target localhost inventory id
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/inventories/?organization={{ target_org_id }}&name={{ target_localhost_inventory_name | urlencode }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: tgt_inv

    - name: Guard - target localhost inventory found
      ansible.builtin.assert:
        that:
          - tgt_inv.json.count == 1
        fail_msg: "Target localhost inventory not found (check target_localhost_inventory_name)."

    - name: Set target_localhost_inventory_id
      ansible.builtin.set_fact:
        target_localhost_inventory_id: "{{ tgt_inv.json.results[0].id }}"

    - name: Build target credential name->id map
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/credentials/?organization={{ target_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: tgt_creds

    - name: Guard - creds pagination not required
      ansible.builtin.assert:
        that:
          - tgt_creds.json.next is not defined or tgt_creds.json.next is none
        fail_msg: "Pagination required for credentials - increase page_size or implement paging."

    - name: Set dst_cred_map
      ansible.builtin.set_fact:
        dst_cred_map: "{{ dict(tgt_creds.json.results | map(attribute='name') | zip(tgt_creds.json.results | map(attribute='id'))) }}"

    # ------------------------------------------------------------------------
    # Fetch job templates from source org
    # ------------------------------------------------------------------------
    - name: Fetch job templates in source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/?organization={{ source_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_templates_raw

    - name: Guard - templates pagination not required
      ansible.builtin.assert:
        that:
          - source_templates_raw.json.next is not defined or source_templates_raw.json.next is none
        fail_msg: "Pagination required for templates - increase page_size or implement paging."

    - name: Set source templates list
      ansible.builtin.set_fact:
        source_templates: "{{ source_templates_raw.json.results }}"

    # ------------------------------------------------------------------------
    # Selection (wildcard include/exclude -> safe regex)
    # ------------------------------------------------------------------------
    - name: Parse include/exclude patterns (comma-separated wildcards)
      ansible.builtin.set_fact:
        include_patterns: >-
          {{
            template_include.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_include | length > 0
            else ['.*']
          }}
        exclude_patterns: >-
          {{
            template_exclude.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_exclude | length > 0
            else []
          }}

    - name: Select templates
      ansible.builtin.set_fact:
        selected_templates: >-
          {{
            source_templates
            if copy_all_templates
            else
            (
              source_templates
              | selectattr('name', 'match', include_patterns | join('|'))
              | rejectattr('name', 'match', exclude_patterns | join('|'))
              | list
            )
          }}

    - name: Guard - at least one template selected
      ansible.builtin.assert:
        that:
          - selected_templates | length > 0
        fail_msg: "No templates matched selection."

    - name: Dry run - list what would be copied (names only)
      ansible.builtin.debug:
        msg:
          - "DRY RUN: would copy {{ selected_templates | length }} templates from '{{ source_org_name }}' -> '{{ target_org_name }}':"
          - "{{ selected_templates | map(attribute='name') | list }}"
      when: dry_run

    - name: Stop after dry run
      ansible.builtin.meta: end_play
      when: dry_run

    # ------------------------------------------------------------------------
    # Fetch details + survey specs, then loop include_tasks (LEGAL pattern)
    # ------------------------------------------------------------------------
    - name: Fetch full detail for each selected template
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_details

    - name: Fetch survey spec for each selected template (200 or 404)
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/survey_spec/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
        status_code: [200, 404]
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_surveys

    - name: Build work list (detail + survey paired)
      ansible.builtin.set_fact:
        templates_work: "{{ jt_details.results | zip(jt_surveys.results) | list }}"

    - name: Copy templates into target org (create/update + survey + creds)
      ansible.builtin.include_tasks: _copy_one_template.yml
      loop: "{{ templates_work }}"
      loop_control:
        label: "{{ item.0.json.name }}"
