---
# ============================================================================
# Playbook: Copy Org Job Templates + Surveys (Bootstrap-aware)
#
# Purpose:
#   - Copy Job Templates from one AWX org to another
#   - Optionally copy Survey Specs and Credentials
#
# Design decisions:
#   - URI-only (no awx.awx / tower_* modules)
#   - include_tasks + loop (NO block+loop â€“ illegal in Ansible)
#   - Defensive guards + verbose annotations
#
# Companion file required (same directory):
#   - copy_one_job_template.yml
# ============================================================================

- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, Selection + Dry Run) [URI-only]"
  hosts: localhost
  gather_facts: false

  vars:
    # ------------------------------------------------------------------------
    # RAW inputs (do NOT template these here)
    # ------------------------------------------------------------------------
    awx_api_base_input: "{{ awx_api_base | default(omit) }}"
    awx_token_input: "{{ awx_token | default(omit) }}"

    # Defaults / constants
    awx_api_base_default: "https://tievaawx01.uksouth.cloudapp.azure.com/api/v2"
    page_size: 200

    # Behaviour flags (normally survey-driven)
    copy_all_templates: "{{ copy_all_templates | default(false) | bool }}"
    template_include: "{{ template_include | default('') }}"
    template_exclude: "{{ template_exclude | default('') }}"
    dry_run: "{{ dry_run | default(false) | bool }}"
    debug_mode: "{{ debug_mode | default(false) | bool }}"

    # SSL
    tower_verify_ssl: "{{ tower_verify_ssl | default(true) | bool }}"

  tasks:

    # ------------------------------------------------------------------------
    # Normalise controller connection variables (CRITICAL FIX)
    # ------------------------------------------------------------------------
    - name: Normalise AWX API base URL
      ansible.builtin.set_fact:
        awx_api_base: "{{ (awx_api_base_input if (awx_api_base_input is string and awx_api_base_input | length > 0) else awx_api_base_default) }}"

    - name: Normalise AWX token
      ansible.builtin.set_fact:
        awx_token: "{{ awx_token_input | default('') }}"

    - name: Guard - ensure controller connection variables are present
      ansible.builtin.assert:
        that:
          - awx_api_base is string
          - awx_api_base | length > 0
          - awx_token is string
          - awx_token | length > 0
        fail_msg: "Missing or invalid awx_api_base / awx_token"


    - name: Set common AWX headers
      ansible.builtin.set_fact:
        awx_headers:
          Authorization: "Bearer {{ awx_token }}"
          Content-Type: "application/json"

    - name: Guard - ensure org inputs provided
      ansible.builtin.assert:
        that:
          - source_org_name is defined
          - target_org_name is defined
        fail_msg: "Missing source_org_name or target_org_name"

    - name: Debug - show raw inputs
      ansible.builtin.debug:
        msg:
          - "awx_api_base={{ awx_api_base }}"
          - "copy_all_templates={{ copy_all_templates }}"
          - "template_include={{ template_include }}"
          - "template_exclude={{ template_exclude }}"
          - "dry_run={{ dry_run }}"
      when: debug_mode

    # ------------------------------------------------------------------------
    # Lookup org IDs
    # ------------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ source_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_org

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ target_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: target_org

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - source_org.json.count == 1
          - target_org.json.count == 1

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ source_org.json.results[0].id }}"
        target_org_id: "{{ target_org.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Fetch job templates from source org
    # ------------------------------------------------------------------------
    - name: Fetch job templates in source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/?organization={{ source_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_templates_raw

    - name: Guard - pagination not required
      ansible.builtin.assert:
        that:
          - source_templates_raw.json.next is not defined or source_templates_raw.json.next is none

    - name: Set source templates list
      ansible.builtin.set_fact:
        source_templates: "{{ source_templates_raw.json.results }}"

    # ------------------------------------------------------------------------
    # Parse include / exclude wildcards safely
    # ------------------------------------------------------------------------
    - name: Parse include/exclude patterns
      ansible.builtin.set_fact:
        include_patterns: >-
          {{
            template_include.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_include | length > 0
            else ['.*']
          }}
        exclude_patterns: >-
          {{
            template_exclude.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_exclude | length > 0
            else []
          }}

    - name: Select templates
      ansible.builtin.set_fact:
        selected_templates: >-
          {{
            source_templates
            if copy_all_templates
            else
            (
              source_templates
              | selectattr('name', 'match', include_patterns | join('|'))
              | rejectattr('name', 'match', exclude_patterns | join('|'))
              | list
            )
          }}

    - name: Guard - templates selected
      ansible.builtin.assert:
        that:
          - selected_templates | length > 0
        fail_msg: "No templates matched selection"

    - name: Dry run output
      ansible.builtin.debug:
        msg: "{{ selected_templates | map(attribute='name') | list }}"
      when: dry_run

    - name: Stop after dry run
      ansible.builtin.meta: end_play
      when: dry_run

    # ------------------------------------------------------------------------
    # Fetch details + surveys
    # ------------------------------------------------------------------------
    - name: Fetch full detail for each template
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      loop: "{{ selected_templates }}"
      register: jt_details

    - name: Fetch survey specs
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/survey_spec/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
        status_code: [200, 404]
      loop: "{{ selected_templates }}"
      register: jt_surveys

    - name: Build work list
      ansible.builtin.set_fact:
        templates_work: "{{ jt_details.results | zip(jt_surveys.results) | list }}"

    # ------------------------------------------------------------------------
    # Copy templates (LEGAL loop)
    # ------------------------------------------------------------------------
    - name: Copy templates into target org
      ansible.builtin.include_tasks: copy_one_job_template.yml
      loop: "{{ templates_work }}"
      loop_control:
        label: "{{ item.0.json.name }}"
