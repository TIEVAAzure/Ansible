---
- name: AWX: Copy Job Templates + Surveys (Bootstrap-aware, Selection + Dry Run) [URI-only]
  hosts: localhost
  gather_facts: false

  vars:
    awx_api_base: "{{ awx_api_base | default('https://tievaawx01.uksouth.cloudapp.azure.com/api/v2') }}"
    awx_token: "{{ awx_token }}"
    page_size: 200

  tasks:

    - name: Guard - ensure controller connection is available
      ansible.builtin.assert:
        that:
          - awx_api_base is defined
          - awx_token is defined
        fail_msg: "Controller API base or token missing"

    - name: Guard - ensure org inputs provided
      ansible.builtin.assert:
        that:
          - source_org_name is defined
          - target_org_name is defined
        fail_msg: "Source or target org name missing"

    - name: Debug - show raw selection inputs
      ansible.builtin.debug:
        msg:
          - "copy_all_templates={{ copy_all_templates | default(false) }}"
          - "template_include='{{ template_include | default('') }}'"
          - "template_exclude='{{ template_exclude | default('') }}'"
          - "dry_run={{ dry_run | default(false) }}"
          - "debug_mode={{ debug_mode | default(false) }}"
          - "awx_api_base={{ awx_api_base }}"

    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ source_org_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ awx_token }}"
        return_content: true
      register: source_org

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ target_org_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ awx_token }}"
        return_content: true
      register: target_org

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - source_org.json.count == 1
          - target_org.json.count == 1

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ source_org.json.results[0].id }}"
        target_org_id: "{{ target_org.json.results[0].id }}"

    - name: Fetch job templates in source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/?organization={{ source_org_id }}&page_size={{ page_size }}"
        method: GET
        headers:
          Authorization: "Bearer {{ awx_token }}"
        return_content: true
      register: source_templates_raw

    - name: Guard - templates pagination not required
      ansible.builtin.assert:
        that:
          - source_templates_raw.json.next is not defined or source_templates_raw.json.next is none

    - name: Set source templates list
      ansible.builtin.set_fact:
        source_templates: "{{ source_templates_raw.json.results }}"

    - name: Parse include/exclude patterns
      ansible.builtin.set_fact:
        include_patterns: >-
          {{
            template_include.split(',')
            | map('trim')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_include | default('') | length > 0
            else ['.*']
          }}
        exclude_patterns: >-
          {{
            template_exclude.split(',')
            | map('trim')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_exclude | default('') | length > 0
            else []
          }}

    - name: Select templates
      ansible.builtin.set_fact:
        templates_selected: >-
          {{
            source_templates
            if copy_all_templates | bool
            else
            (
              source_templates
              | selectattr('name', 'match', include_patterns | join('|'))
              | rejectattr('name', 'match', exclude_patterns | join('|'))
              | list
            )
          }}

    - name: Guard - templates selected
      ansible.builtin.assert:
        that:
          - templates_selected | length > 0
        fail_msg: "No templates matched selection criteria"

    - name: Fetch surveys for selected templates
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/survey_spec/"
        method: GET
        headers:
          Authorization: "Bearer {{ awx_token }}"
        return_content: true
      loop: "{{ templates_selected }}"
      register: surveys_raw

    - name: Build templates_work structure
      ansible.builtin.set_fact:
        templates_work: "{{ templates_work | default([]) + [ [item.0, item.1] ] }}"
      loop: "{{ templates_selected | zip(surveys_raw.results) | list }}"

    - name: Copy templates into target org (create/update via API)
      ansible.builtin.include_tasks: copy_one_job_template.yml
      loop: "{{ templates_work }}"
      loop_control:
        label: "{{ item.0.name }}"
