---
- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, URI-only, FIXED regex)"
  hosts: localhost
  gather_facts: false

  vars:
    target_project_name: "{{ target_org_name }} - TIEVAAzure-Ansible"
    target_localhost_inventory_name: "{{ target_org_name }} - Localhost"
    source_localhost_inventory_name: "Localhost"

    dry_run: false
    debug_mode: false

    copy_all_templates: false
    template_include: ""
    template_exclude: ""

    allow_only_localhost_inventory_mapping: true
    create_templates_without_missing_creds: true

    controller_host: "{{ tower_host }}"
    controller_oauthtoken: "{{ tower_oauth_token }}"
    controller_validate_certs: "{{ tower_verify_ssl | default(true) | bool }}"

  tasks:
    # ------------------------------------------------------------------
    # Guards
    # ------------------------------------------------------------------
    - name: Guard - controller vars
      ansible.builtin.assert:
        that:
          - controller_host | length > 0
          - controller_oauthtoken | length > 0

    - name: Guard - org vars
      ansible.builtin.assert:
        that:
          - source_org_name | length > 0
          - target_org_name | length > 0

    # ------------------------------------------------------------------
    # Org lookups
    # ------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ controller_host }}/api/v2/organizations/?name={{ source_org_name | urlencode }}"
        method: GET
        headers:
          Authorization: "Bearer {{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: src_org

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ controller_host }}/api/v2/organizations/?name={{ target_org_name | urlencode }}"
        method: GET
        headers:
          Authorization: "Bearer {{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: dst_org

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ src_org.json.results[0].id }}"
        target_org_id: "{{ dst_org.json.results[0].id }}"

    # ------------------------------------------------------------------
    # Fetch job templates
    # ------------------------------------------------------------------
    - name: Fetch source job templates
      ansible.builtin.uri:
        url: "{{ controller_host }}/api/v2/job_templates/?organization={{ source_org_id }}&page_size=200"
        method: GET
        headers:
          Authorization: "Bearer {{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: src_jts

    - name: Extract template names
      ansible.builtin.set_fact:
        all_templates: "{{ src_jts.json.results }}"
        all_template_names: "{{ src_jts.json.results | map(attribute='name') | list }}"

    # ------------------------------------------------------------------
    # Pattern parsing (FIXED)
    # ------------------------------------------------------------------
    - name: Parse include/exclude patterns
      ansible.builtin.set_fact:
        include_patterns: "{{ template_include | default('') | split(',') | map('trim') | reject('equalto','') | list }}"
        exclude_patterns: "{{ template_exclude | default('') | split(',') | map('trim') | reject('equalto','') | list }}"

    - name: Build safe regex from wildcards (NO regex_escape)
      ansible.builtin.set_fact:
        include_combined_regex: >-
          {{
            include_patterns | length > 0
            | ternary(
                '^(?:' ~
                (include_patterns
                  | map('regex_replace','\\*','.*')
                  | map('regex_replace','\\?','.')
                  | join('|')
                ) ~ ')$',
                '.*'
              )
          }}
        exclude_combined_regex: >-
          {{
            exclude_patterns | length > 0
            | ternary(
                '^(?:' ~
                (exclude_patterns
                  | map('regex_replace','\\*','.*')
                  | map('regex_replace','\\?','.')
                  | join('|')
                ) ~ ')$',
                'a^'
              )
          }}

    - name: Select templates
      ansible.builtin.set_fact:
        selected_templates: >-
          {{
            all_templates
            | selectattr('name','match', include_combined_regex)
            | rejectattr('name','match', exclude_combined_regex)
            | list
          }}

    - name: Debug selection
      ansible.builtin.debug:
        msg:
          - "Include regex: {{ include_combined_regex }}"
          - "Exclude regex: {{ exclude_combined_regex }}"
          - "Selected templates: {{ selected_templates | map(attribute='name') | list }}"
      when: debug_mode | bool

    - name: Guard - templates selected
      ansible.builtin.assert:
        that:
          - selected_templates | length > 0
        fail_msg: "No templates matched selection."

    # ------------------------------------------------------------------
    # Dry run
    # ------------------------------------------------------------------
    - name: Dry run output
      ansible.builtin.debug:
        msg: "{{ selected_templates | map(attribute='name') | list }}"
      when: dry_run | bool

    - meta: end_play
      when: dry_run | bool