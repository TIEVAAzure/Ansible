---
# Playbook-Admin/Copy Templates + Surveys (Bootstrap Aware).yml
#
# Purpose:
#   Copy selected Job Templates (including Surveys + ask_* flags) from a SOURCE org
#   into a TARGET org, while being "bootstrap aware" (i.e. assumes the TARGET org
#   already has a project + localhost inventory created by your bootstrap playbook).
#
# Key behaviour:
#   - Selection via include/exclude wildcards (comma-separated)
#   - Dry run mode prints what WOULD be copied and exits cleanly
#   - Inventory mapping:
#       * If allow_only_localhost_inventory_mapping=True, only templates whose inventory
#         is "Localhost" will be copied, and they will map to target inventory name
#         (defaults to target_org_name).
#   - Credentials:
#       * If create_templates_without_missing_creds=True, templates are created without
#         attaching creds when they don’t exist in the target org (and we log them).
#       * If False, templates missing creds will be skipped (and logged).
#
# Requirements (EE):
#   - awx.awx collection installed in the EE
#   - Uses ONLY awx.awx.* modules (NO controller_api)

- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, with Dry Run)"
  hosts: localhost
  gather_facts: false

  vars:
    # ---------------------------------------------------------------------
    # Controller connection (passed via Job Template extra vars / survey)
    # ---------------------------------------------------------------------
    tower_host: "{{ tower_host | default(omit) }}"
    tower_oauth_token: "{{ tower_oauth_token | default(omit) }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(true) }}"

    # ---------------------------------------------------------------------
    # Orgs
    # ---------------------------------------------------------------------
    source_org_name: "{{ source_org_name | default(omit) }}"
    target_org_name: "{{ target_org_name | default(omit) }}"

    # ---------------------------------------------------------------------
    # Bootstrap-aware defaults:
    #   Use the target org name for project + inventory names by default.
    #   (Matches what you asked for: project name follows target_org_name like inventory.)
    # ---------------------------------------------------------------------
    target_project_name: "{{ target_project_name | default(target_org_name) }}"
    target_inventory_name: "{{ target_inventory_name | default(target_org_name) }}"

    # ---------------------------------------------------------------------
    # Selection
    # ---------------------------------------------------------------------
    dry_run: "{{ dry_run | default(true) | bool }}"
    copy_all_templates: "{{ copy_all_templates | default(false) | bool }}"
    template_include: "{{ template_include | default('') }}"
    template_exclude: "{{ template_exclude | default('') }}"

    # ---------------------------------------------------------------------
    # Mapping / behaviour toggles
    # ---------------------------------------------------------------------
    allow_only_localhost_inventory_mapping: "{{ allow_only_localhost_inventory_mapping | default(true) | bool }}"
    create_templates_without_missing_creds: "{{ create_templates_without_missing_creds | default(true) | bool }}"

  tasks:
    # ---------------------------------------------------------------------
    # Guards
    # ---------------------------------------------------------------------
    - name: Guard - controller vars present
      ansible.builtin.assert:
        that:
          - tower_host is defined
          - tower_oauth_token is defined
        fail_msg: "Controller connection not configured. Provide tower_host and tower_oauth_token via survey/extra vars."

    - name: Guard - org vars present
      ansible.builtin.assert:
        that:
          - source_org_name is defined
          - target_org_name is defined
        fail_msg: "Provide source_org_name and target_org_name."

    # ---------------------------------------------------------------------
    # Lookup orgs
    # ---------------------------------------------------------------------
    - name: Lookup source org
      awx.awx.organization_info:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"
        name: "{{ source_org_name }}"
      register: src_org_rsp

    - name: Lookup target org
      awx.awx.organization_info:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"
        name: "{{ target_org_name }}"
      register: tgt_org_rsp

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - (src_org_rsp.organizations | length) == 1
          - (tgt_org_rsp.organizations | length) == 1
        fail_msg: "Expected exactly 1 result for source and target org. Check names / duplicates."

    - name: Set org IDs
      ansible.builtin.set_fact:
        src_org_id: "{{ src_org_rsp.organizations[0].id }}"
        tgt_org_id: "{{ tgt_org_rsp.organizations[0].id }}"

    # ---------------------------------------------------------------------
    # Lookup bootstrap-created project + inventory in target org
    # ---------------------------------------------------------------------
    - name: Lookup target project (bootstrap-created)
      awx.awx.project_info:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"
        name: "{{ target_project_name }}"
        organization: "{{ target_org_name }}"
      register: tgt_proj_rsp

    - name: Guard - target project exists (bootstrap must have created it)
      ansible.builtin.assert:
        that:
          - (tgt_proj_rsp.projects | length) == 1
        fail_msg: "Target project '{{ target_project_name }}' not found in org '{{ target_org_name }}'. Run bootstrap first."

    - name: Lookup target inventory (bootstrap-created)
      awx.awx.inventory_info:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"
        name: "{{ target_inventory_name }}"
        organization: "{{ target_org_name }}"
      register: tgt_inv_rsp

    - name: Guard - target inventory exists (bootstrap must have created it)
      ansible.builtin.assert:
        that:
          - (tgt_inv_rsp.inventories | length) == 1
        fail_msg: "Target inventory '{{ target_inventory_name }}' not found in org '{{ target_org_name }}'. Run bootstrap first."

    - name: Set target project/inventory IDs
      ansible.builtin.set_fact:
        tgt_project_id: "{{ tgt_proj_rsp.projects[0].id }}"
        tgt_inventory_id: "{{ tgt_inv_rsp.inventories[0].id }}"

    # ---------------------------------------------------------------------
    # Fetch source templates
    # ---------------------------------------------------------------------
    - name: Fetch all job templates (controller-wide)
      awx.awx.job_template_info:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"
      register: all_jt_rsp

    - name: Filter job templates to source org only
      ansible.builtin.set_fact:
        src_jt_list: >-
          {{
            (all_jt_rsp.job_templates | default([]))
            | selectattr('summary_fields.organization.id', 'defined')
            | selectattr('summary_fields.organization.id', 'equalto', src_org_id)
            | list
          }}

    - name: Build list of available source template names (for troubleshooting)
      ansible.builtin.set_fact:
        available_template_names: "{{ src_jt_list | map(attribute='name') | list }}"

    # ---------------------------------------------------------------------
    # Selection logic (survey-driven) - FIXED matching + dash/space normalised
    # ---------------------------------------------------------------------
    - name: Parse include/exclude lists into arrays
      ansible.builtin.set_fact:
        template_include_list: >-
          {{
            (template_include | default('') | string)
            | split(',')
            | map('trim')
            | reject('equalto','')
            | list
          }}
        template_exclude_list: >-
          {{
            (template_exclude | default('') | string)
            | split(',')
            | map('trim')
            | reject('equalto','')
            | list
          }}

    - name: Normalise include/exclude patterns and build combined regex strings
      vars:
        # Normalise dash variants and any spacing around them to a canonical " - "
        include_norm: >-
          {{
            template_include_list
            | map('regex_replace', '\\s*[–—-]\\s*', ' - ')
            | map('regex_replace', '\\s+', ' ')
            | map('trim')
            | list
          }}
        exclude_norm: >-
          {{
            template_exclude_list
            | map('regex_replace', '\\s*[–—-]\\s*', ' - ')
            | map('regex_replace', '\\s+', ' ')
            | map('trim')
            | list
          }}

        # Convert wildcard -> safe regex (anchored)
        include_regexes_calc: >-
          {{
            include_norm
            | map('regex_escape')
            | map('regex_replace', '\\\\*', '.*')
            | map('regex_replace', '^', '^')
            | map('regex_replace', '$', '$')
            | list
          }}
        exclude_regexes_calc: >-
          {{
            exclude_norm
            | map('regex_escape')
            | map('regex_replace', '\\\\*', '.*')
            | map('regex_replace', '^', '^')
            | map('regex_replace', '$', '$')
            | list
          }}

        include_combined_calc: >-
          {{
            ((include_regexes_calc | length) > 0)
            | ternary('(?:' ~ (include_regexes_calc | join('|')) ~ ')', '')
          }}
        exclude_combined_calc: >-
          {{
            ((exclude_regexes_calc | length) > 0)
            | ternary('(?:' ~ (exclude_regexes_calc | join('|')) ~ ')', '')
          }}

      ansible.builtin.set_fact:
        include_regexes: "{{ include_regexes_calc }}"
        exclude_regexes: "{{ exclude_regexes_calc }}"
        include_combined: "{{ include_combined_calc }}"
        exclude_combined: "{{ exclude_combined_calc }}"

    - name: Debug include/exclude combined regex
      ansible.builtin.debug:
        msg:
          - "include (raw)='{{ template_include }}' -> include_regexes={{ include_regexes }}"
          - "exclude (raw)='{{ template_exclude }}' -> exclude_regexes={{ exclude_regexes }}"
          - "include_combined={{ include_combined }}"
          - "exclude_combined={{ exclude_combined }}"

    - name: Select job templates from source list according to include/exclude rules (CORRECT direction)
      vars:
        name_norm: >-
          {{
            (item.name | string)
            | regex_replace('\\s*[–—-]\\s*', ' - ')
            | regex_replace('\\s+', ' ')
            | trim
          }}

        include_hit: >-
          {{
            (copy_all_templates | bool)
            or
            (
              (include_combined | length) > 0
              and
              (name_norm is match(include_combined))
            )
          }}

        exclude_hit: >-
          {{
            (exclude_combined | length) > 0
            and
            (name_norm is match(exclude_combined))
          }}

      ansible.builtin.set_fact:
        selected_jt_raw: "{{ (selected_jt_raw | default([])) + ([item] if (include_hit and not exclude_hit) else []) }}"
      loop: "{{ src_jt_list }}"

    - name: Set selected template names (for reporting)
      ansible.builtin.set_fact:
        selected_template_names: "{{ (selected_jt_raw | default([])) | map(attribute='name') | list }}"

    - name: Print selection summary
      ansible.builtin.debug:
        msg:
          - "Selection summary:"
          - "copy_all_templates={{ copy_all_templates }}, dry_run={{ dry_run }}"
          - "include='{{ template_include | default('') }}'"
          - "exclude='{{ template_exclude | default('') }}'"
          - "Selected {{ selected_template_names | length }} template(s):"
          - "{{ selected_template_names }}"

    - name: If selection is empty, print first 50 available template names (to help pick patterns)
      ansible.builtin.debug:
        msg:
          - "No templates matched selection."
          - "You used: copy_all_templates={{ copy_all_templates }}, include='{{ template_include | default('') }}', exclude='{{ template_exclude | default('') }}'"
          - "First 50 available template names:"
          - "{{ available_template_names[:50] }}"
      when: (selected_jt_raw | default([]) | length) == 0

    - name: If dry_run and selection is empty, stop cleanly (no failure)
      ansible.builtin.meta: end_play
      when:
        - dry_run
        - (selected_jt_raw | default([]) | length) == 0

    - name: Guard - selection not empty (only fails when not dry_run)
      ansible.builtin.assert:
        that:
          - (selected_jt_raw | length) > 0
        fail_msg: >
          No templates matched your selection.
          copy_all_templates={{ copy_all_templates }},
          include='{{ template_include | default('') }}',
          exclude='{{ template_exclude | default('') }}'.
      when: not dry_run

    # ---------------------------------------------------------------------
    # Inventory mapping check (optional strictness)
    # ---------------------------------------------------------------------
    - name: Build copy plan (and apply localhost-only inventory rule if enabled)
      vars:
        src_inventory_name: "{{ (item.summary_fields.inventory.name | default('')) }}"
        inventory_ok: >-
          {{
            (not allow_only_localhost_inventory_mapping)
            or
            (src_inventory_name == 'Localhost')
          }}
      ansible.builtin.set_fact:
        copy_plan: "{{ (copy_plan | default([])) + ([item] if inventory_ok else []) }}"
        skipped_due_to_inventory: "{{ (skipped_due_to_inventory | default([])) + ([item.name] if (not inventory_ok) else []) }}"
      loop: "{{ selected_jt_raw }}"

    - name: Report inventory-mapping skips (if any)
      ansible.builtin.debug:
        msg:
          - "Skipped due to inventory mapping rule (allow_only_localhost_inventory_mapping=True):"
          - "{{ skipped_due_to_inventory }}"
      when: (skipped_due_to_inventory | default([]) | length) > 0

    - name: If dry_run, print final plan and exit cleanly
      ansible.builtin.debug:
        msg:
          - "DRY RUN: Would copy {{ (copy_plan | default([]) | length) }} template(s) into org '{{ target_org_name }}'"
          - "Target project='{{ target_project_name }}' inventory='{{ target_inventory_name }}'"
          - "{{ (copy_plan | default([])) | map(attribute='name') | list }}"
      when: dry_run

    - name: End play (dry_run)
      ansible.builtin.meta: end_play
      when: dry_run

    # ---------------------------------------------------------------------
    # Copy templates (real run)
    # NOTE:
    #   This uses awx.awx.job_template to upsert the template in the target org.
    #   Surveys are copied via survey_spec/survey_enabled if present in source info.
    # ---------------------------------------------------------------------

    - name: Copy job templates into target org (bootstrap-aware)
      vars:
        src_name: "{{ item.name }}"
        src_playbook: "{{ item.playbook | default(omit) }}"
        src_job_type: "{{ item.job_type | default(omit) }}"
        src_ee: "{{ item.execution_environment | default(omit) }}"
        src_verbosity: "{{ item.verbosity | default(omit) }}"
        src_forks: "{{ item.forks | default(omit) }}"
        src_timeout: "{{ item.timeout | default(omit) }}"

        # Ask-on-launch flags
        ask_inventory_on_launch: "{{ item.ask_inventory_on_launch | default(false) }}"
        ask_variables_on_launch: "{{ item.ask_variables_on_launch | default(false) }}"
        ask_limit_on_launch: "{{ item.ask_limit_on_launch | default(false) }}"
        ask_tags_on_launch: "{{ item.ask_tags_on_launch | default(false) }}"
        ask_skip_tags_on_launch: "{{ item.ask_skip_tags_on_launch | default(false) }}"
        ask_job_type_on_launch: "{{ item.ask_job_type_on_launch | default(false) }}"
        ask_verbosity_on_launch: "{{ item.ask_verbosity_on_launch | default(false) }}"
        ask_execution_environment_on_launch: "{{ item.ask_execution_environment_on_launch | default(false) }}"
        ask_forks_on_launch: "{{ item.ask_forks_on_launch | default(false) }}"
        ask_timeout_on_launch: "{{ item.ask_timeout_on_launch | default(false) }}"
        ask_diff_mode_on_launch: "{{ item.ask_diff_mode_on_launch | default(false) }}"

        # Extra vars default
        extra_vars: "{{ item.extra_vars | default(omit) }}"

        # Survey
        survey_enabled: "{{ item.survey_enabled | default(false) }}"
        survey_spec: "{{ item.survey_spec | default(omit) }}"

      awx.awx.job_template:
        controller_host: "{{ tower_host }}"
        controller_oauthtoken: "{{ tower_oauth_token }}"
        validate_certs: "{{ tower_verify_ssl }}"

        name: "{{ src_name }}"
        description: "{{ item.description | default('') }}"
        organization: "{{ target_org_name }}"

        project: "{{ target_project_name }}"
        inventory: "{{ target_inventory_name }}"
        playbook: "{{ src_playbook }}"
        job_type: "{{ src_job_type }}"

        execution_environment: "{{ src_ee }}"
        verbosity: "{{ src_verbosity }}"
        forks: "{{ src_forks }}"
        timeout: "{{ src_timeout }}"

        ask_inventory_on_launch: "{{ ask_inventory_on_launch }}"
        ask_variables_on_launch: "{{ ask_variables_on_launch }}"
        ask_limit_on_launch: "{{ ask_limit_on_launch }}"
        ask_tags_on_launch: "{{ ask_tags_on_launch }}"
        ask_skip_tags_on_launch: "{{ ask_skip_tags_on_launch }}"
        ask_job_type_on_launch: "{{ ask_job_type_on_launch }}"
        ask_verbosity_on_launch: "{{ ask_verbosity_on_launch }}"
        ask_execution_environment_on_launch: "{{ ask_execution_environment_on_launch }}"
        ask_forks_on_launch: "{{ ask_forks_on_launch }}"
        ask_timeout_on_launch: "{{ ask_timeout_on_launch }}"
        ask_diff_mode_on_launch: "{{ ask_diff_mode_on_launch }}"

        extra_vars: "{{ extra_vars }}"

        survey_enabled: "{{ survey_enabled }}"
        survey_spec: "{{ survey_spec }}"

        state: present
      loop: "{{ copy_plan | default([]) }}"
      register: copy_results

    - name: Copy complete summary
      ansible.builtin.debug:
        msg:
          - "Copied/updated {{ (copy_plan | default([]) | length) }} templates into org '{{ target_org_name }}'."
          - "Target project='{{ target_project_name }}' inventory='{{ target_inventory_name }}'"
          - "Templates:"
          - "{{ (copy_plan | default([])) | map(attribute='name') | list }}"