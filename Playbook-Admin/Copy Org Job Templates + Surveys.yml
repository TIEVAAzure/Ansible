---
# ============================================================================
# Playbook: Copy Org Job Templates + Surveys (Bootstrap-aware)
#
# Purpose:
#   - Copy Job Templates from one AWX org to another
#   - Optionally copy Survey Specs and Credentials
#
# Design decisions:
#   - URI-only (no awx.awx / tower_* modules/collections)
#   - include_tasks + loop (NO block+loop – illegal in Ansible)
#   - Defensive guards + verbose annotations
#
# Companion file required (same directory):
#   - copy_one_job_template.yml
# ============================================================================

- name: "AWX: Copy Job Templates + Surveys (Bootstrap-aware, Selection + Dry Run) [URI-only]"
  hosts: localhost
  gather_facts: false

  vars:
    # ------------------------------------------------------------------------
    # Inputs as stored on the AWX Job Template (you showed these in your UI)
    # ------------------------------------------------------------------------
    tower_host: "{{ tower_host | default(omit) }}"
    tower_oauth_token: "{{ tower_oauth_token | default(omit) }}"
    tower_verify_ssl: "{{ tower_verify_ssl | default(true) | bool }}"

    # ------------------------------------------------------------------------
    # Normalised internal names (we use these everywhere in the playbook)
    # NOTE: tower_host is typically like https://host (NO /api/v2)
    # We normalise it to https://host/api/v2
    # ------------------------------------------------------------------------
    awx_api_base_default: "https://tievaawx01.uksouth.cloudapp.azure.com"
    awx_api_base_input: "{{ tower_host | default(omit) }}"
    awx_token_input: "{{ tower_oauth_token | default(omit) }}"

    # Paging – keep high to avoid pagination complexity (we assert next == null)
    page_size: 200

    # Selection inputs (normally from Survey)
    copy_all_templates: "{{ copy_all_templates | default(false) | bool }}"
    template_include: "{{ template_include | default('') }}"
    template_exclude: "{{ template_exclude | default('') }}"
    dry_run: "{{ dry_run | default(false) | bool }}"
    debug_mode: "{{ debug_mode | default(false) | bool }}"

  tasks:

    # ------------------------------------------------------------------------
    # Normalise controller connection variables (CRITICAL)
    # - ensure awx_api_base ends in /api/v2
    # - ensure token is a non-empty string
    # ------------------------------------------------------------------------
    - name: Normalise AWX API base URL
      ansible.builtin.set_fact:
        awx_api_base: >-
          {{
            (
              (awx_api_base_input
                if (awx_api_base_input is string and awx_api_base_input | length > 0)
                else awx_api_base_default
              )
              | regex_replace('/+$', '')
            )
            ~ (
              '/api/v2'
              if (
                (
                  (awx_api_base_input
                    if (awx_api_base_input is string and awx_api_base_input | length > 0)
                    else awx_api_base_default
                  )
                  | regex_replace('/+$', '')
                ) is not search('/api/v2$')
              )
              else ''
            )
          }}

    - name: Normalise AWX token
      ansible.builtin.set_fact:
        awx_token: "{{ awx_token_input | default('') }}"

    - name: Guard - ensure controller connection variables are present
      ansible.builtin.assert:
        that:
          - awx_api_base is string
          - awx_api_base | length > 0
          - awx_token is string
          - awx_token | length > 0
        fail_msg: "Missing or invalid tower_host/tower_oauth_token (mapped to awx_api_base/awx_token)"

    - name: Set common AWX headers
      ansible.builtin.set_fact:
        awx_headers:
          Authorization: "Bearer {{ awx_token }}"
          Content-Type: "application/json"

    - name: Guard - ensure org inputs provided
      ansible.builtin.assert:
        that:
          - source_org_name is defined
          - target_org_name is defined
        fail_msg: "Missing source_org_name or target_org_name"

    - name: Debug - show raw inputs
      ansible.builtin.debug:
        msg:
          - "tower_host={{ tower_host | default('UNSET') }}"
          - "awx_api_base={{ awx_api_base }}"
          - "tower_verify_ssl={{ tower_verify_ssl }}"
          - "copy_all_templates={{ copy_all_templates }}"
          - "template_include={{ template_include }}"
          - "template_exclude={{ template_exclude }}"
          - "dry_run={{ dry_run }}"
      when: debug_mode

    # ------------------------------------------------------------------------
    # Lookup org IDs
    # ------------------------------------------------------------------------
    - name: Lookup source org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ source_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_org

    - name: Lookup target org
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/organizations/?name={{ target_org_name }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: target_org

    - name: Guard - org lookups returned exactly one result each
      ansible.builtin.assert:
        that:
          - source_org.json.count == 1
          - target_org.json.count == 1
        fail_msg: "Org lookup did not return exactly one result for source/target"

    - name: Set org IDs
      ansible.builtin.set_fact:
        source_org_id: "{{ source_org.json.results[0].id }}"
        target_org_id: "{{ target_org.json.results[0].id }}"

    # ------------------------------------------------------------------------
    # Fetch job templates in source org
    # ------------------------------------------------------------------------
    - name: Fetch job templates in source org (page_size={{ page_size }})
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/?organization={{ source_org_id }}&page_size={{ page_size }}"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      register: source_templates_raw

    - name: Guard - templates pagination not required (increase page_size or add paging)
      ansible.builtin.assert:
        that:
          - source_templates_raw.json.next is not defined or source_templates_raw.json.next is none
        fail_msg: "Pagination required - increase page_size or implement paging"

    - name: Set source templates list
      ansible.builtin.set_fact:
        source_templates: "{{ source_templates_raw.json.results }}"

    - name: Debug - show first 50 template names (troubleshooting)
      ansible.builtin.debug:
        msg: "{{ source_templates | map(attribute='name') | list | slice(0, 50) }}"
      when: debug_mode

    # ------------------------------------------------------------------------
    # Parse include/exclude (wildcards) -> safe regex
    # ------------------------------------------------------------------------
    - name: Parse include/exclude patterns (comma-separated wildcards)
      ansible.builtin.set_fact:
        include_patterns: >-
          {{
            template_include.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_include | length > 0
            else ['.*']
          }}
        exclude_patterns: >-
          {{
            template_exclude.split(',')
            | map('trim')
            | reject('equalto', '')
            | map('regex_escape')
            | map('regex_replace', '\\*', '.*')
            | list
            if template_exclude | length > 0
            else []
          }}

    - name: Select templates (apply include/exclude unless copy_all_templates=true)
      ansible.builtin.set_fact:
        selected_templates: >-
          {{
            source_templates
            if copy_all_templates
            else
            (
              source_templates
              | selectattr('name', 'match', include_patterns | join('|'))
              | rejectattr('name', 'match', exclude_patterns | join('|'))
              | list
            )
          }}

    - name: Guard - at least one template selected
      ansible.builtin.assert:
        that:
          - selected_templates | length > 0
        fail_msg: >-
          No templates matched selection.
          TIP: include like 'AZ*' or 'AVD*' (no spaces). Enable debug_mode to print names.

    - name: Set selected template names (for reporting)
      ansible.builtin.set_fact:
        selected_template_names: "{{ selected_templates | map(attribute='name') | list }}"

    - name: Dry run - list what would be copied (names only)
      ansible.builtin.debug:
        msg:
          - "DRY RUN: would copy {{ selected_template_names | length }} templates from '{{ source_org_name }}' -> '{{ target_org_name }}':"
          - "{{ selected_template_names }}"
      when: dry_run

    - name: Stop after dry run
      ansible.builtin.meta: end_play
      when: dry_run

    # ------------------------------------------------------------------------
    # Fetch full detail + survey spec for each selected template
    # ------------------------------------------------------------------------
    - name: Fetch full detail for each selected template
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_details

    - name: Fetch survey spec for each selected template (200 or 404)
      ansible.builtin.uri:
        url: "{{ awx_api_base }}/job_templates/{{ item.id }}/survey_spec/"
        method: GET
        headers: "{{ awx_headers }}"
        validate_certs: "{{ tower_verify_ssl }}"
        return_content: true
        status_code: [200, 404]
      loop: "{{ selected_templates }}"
      loop_control:
        label: "{{ item.name }}"
      register: jt_surveys

    - name: Build work list (detail + survey paired)
      ansible.builtin.set_fact:
        templates_work: "{{ jt_details.results | zip(jt_surveys.results) | list }}"

    # ------------------------------------------------------------------------
    # Copy templates into target org
    # IMPORTANT:
    #   - DO NOT use a block with loop (illegal)
    #   - We loop include_tasks (legal)
    # ------------------------------------------------------------------------
    - name: Copy templates into target org (create/update via API)
      ansible.builtin.include_tasks: _copy_one_job_template.yml
      loop: "{{ templates_work }}"
      loop_control:
        label: "{{ item.0.json.name }}"
