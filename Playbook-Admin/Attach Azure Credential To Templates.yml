---
- name: "AWX: Attach Azure Credential to Templates (Target Org)"
  hosts: localhost
  gather_facts: false
  collections:
    - awx.awx

  vars:
    azure_cred_name: "Azure-SP-Prod"
    job_template_name_contains: ""  # optional filter; leave blank to apply to all templates

    controller_host: "{{ tower_host }}"
    controller_oauthtoken: "{{ tower_oauth_token }}"
    controller_validate_certs: "{{ tower_verify_ssl | default(true) }}"

  tasks:
    - name: Guard - required vars
      ansible.builtin.assert:
        that:
          - target_org_name is defined and (target_org_name | length > 0)
          - tower_host is defined and (tower_host | length > 0)
          - tower_oauth_token is defined and (tower_oauth_token | length > 0)

    - name: Get target org ID
      awx.awx.controller_api:
        method: GET
        endpoint: "organizations/"
        query_params:
          name: "{{ target_org_name }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: dst_org_lookup

    - name: Set target org id
      ansible.builtin.set_fact:
        target_org_id: "{{ dst_org_lookup.json.results[0].id }}"

    - name: Lookup Azure credential in target org
      awx.awx.controller_api:
        method: GET
        endpoint: "credentials/"
        query_params:
          organization: "{{ target_org_id }}"
          name: "{{ azure_cred_name }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: az_cred_lookup

    - name: Guard - Azure credential exists
      ansible.builtin.assert:
        that:
          - (az_cred_lookup.json.count | int) == 1
        fail_msg: "Credential '{{ azure_cred_name }}' not found in org '{{ target_org_name }}'. Create it first."

    - name: Set Azure cred id
      ansible.builtin.set_fact:
        az_cred_id: "{{ az_cred_lookup.json.results[0].id }}"

    - name: Fetch job templates in target org
      awx.awx.controller_api:
        method: GET
        endpoint: "job_templates/"
        query_params:
          organization: "{{ target_org_id }}"
          page_size: 200
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      register: dst_jt_list

    - name: Attach Azure credential to templates (optionally filtered by name)
      vars:
        name_ok: "{{ (job_template_name_contains | length == 0) or (job_template_name_contains in jt.name) }}"
        existing_cred_ids: "{{ (jt.summary_fields.credentials | default([])) | map(attribute='id') | list }}"
        new_cred_ids: "{{ (existing_cred_ids + [az_cred_id]) | unique }}"
      awx.awx.job_template:
        name: "{{ jt.name }}"
        organization: "{{ target_org_name }}"
        state: present
        credentials: "{{ new_cred_ids }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      loop: "{{ dst_jt_list.json.results | default([]) }}"
      loop_control:
        loop_var: jt
      when: name_ok

    - name: Done
      ansible.builtin.debug:
        msg: "Attached '{{ azure_cred_name }}' to templates in '{{ target_org_name }}' (filter='{{ job_template_name_contains }}')."