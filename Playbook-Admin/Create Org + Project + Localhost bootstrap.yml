---
# AWX â€“ Org Bootstrap (AWX OSS compatible)
#
# Creates/ensures:
#  - Organization
#  - Shared Project (per-org duplicate) pointing to the shared repo/branch
#  - Localhost inventory + localhost host (ansible_connection=local)
#  - OPTIONAL: Azure Resource Manager credential named "Azure-SP-Prod"
#
# IMPORTANT (AWX OSS):
#  - AWX OSS does NOT reliably support per-Job-Template environment variables.
#  - Therefore this playbook expects Controller connection details via EXTRA VARS.
#
# Put these in the Job Template "Variables" box (JSON or YAML):
#  {
#    "tower_host": "https://tievaawx01.uksouth.cloudapp.azure.com",
#    "tower_oauth_token": "REDACTED",
#    "tower_verify_ssl": true
#  }

- name: "AWX: Org Bootstrap (Org + Project + Localhost + Optional Azure SP)"
  hosts: localhost
  gather_facts: false
  collections:
    - awx.awx

  vars:
    # ===== Shared Project (per-org duplicate) =====
    shared_project_name: "{{ target_org_name }}"
    shared_project_scm_url: "https://github.com/TIEVAAzure/Ansible"
    shared_project_scm_branch: "main"

    # Repo is public for now - leave blank
    shared_project_scm_credential_name: ""

    # ===== Localhost inventory =====
    localhost_inventory_name: "{{ target_org_name }} - Localhost"
    localhost_host_name: "localhost"
    localhost_host_vars:
      ansible_connection: "local"
      ansible_python_interpreter: "/usr/bin/python3"

    # ===== Optional Azure SP credential baseline =====
    azure_arm_cred_name: "{{ target_org_name }} - Azure-SP-Prod"

    # Toggle (set via AWX Survey)
    create_azure_sp: false

    # Required only when create_azure_sp=true (set via AWX Survey)
    azure_subscription_id: ""
    azure_tenant: ""
    azure_client_id: ""
    azure_client_secret: ""

    # ===== Controller connection (AWX OSS: provided via extra vars) =====
    # These are expected to be provided in the Job Template "Variables" box:
    #   tower_host, tower_oauth_token, tower_verify_ssl
    controller_host: "{{ tower_host }}"
    controller_oauthtoken: "{{ tower_oauth_token }}"
    controller_validate_certs: "{{ tower_verify_ssl | default(true) }}"

  tasks:
    # -------------------------------------------------------------------------
    # Guard rails: prevent localhost fallback
    # -------------------------------------------------------------------------
    - name: Guard - ensure controller connection is available (AWX OSS via extra vars)
      ansible.builtin.assert:
        that:
          - tower_host is defined
          - tower_host | length > 0
          - tower_oauth_token is defined
          - tower_oauth_token | length > 0
        fail_msg: >
          Controller connection not configured.
          Provide tower_host and tower_oauth_token via the Job Template "Variables" box.

    # -------------------------------------------------------------------------
    # Required input: target org name (expected via Survey)
    # -------------------------------------------------------------------------
    - name: Guard - ensure target_org_name provided
      ansible.builtin.assert:
        that:
          - target_org_name is defined
          - target_org_name | length > 0
        fail_msg: "target_org_name is required (set via Survey)."

    # -------------------------------------------------------------------------
    # 1) Organization
    # -------------------------------------------------------------------------
    - name: Ensure target org exists
      awx.awx.organization:
        name: "{{ target_org_name }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"

    # -------------------------------------------------------------------------
    # 2) Shared Project (per-org)
    # -------------------------------------------------------------------------
    - name: Ensure shared project exists in target org
      awx.awx.project:
        name: "{{ shared_project_name }}"
        organization: "{{ target_org_name }}"
        state: present
        scm_type: git
        scm_url: "{{ shared_project_scm_url }}"
        scm_branch: "{{ shared_project_scm_branch }}"
        scm_clean: true
        scm_delete_on_update: true
        scm_update_on_launch: true
        scm_credential: "{{ shared_project_scm_credential_name | default('') | string | trim | default(omit, true) }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"

    - name: Trigger project update (optional sanity check)
      awx.awx.project_update:
        project: "{{ shared_project_name }}"
        organization: "{{ target_org_name }}"
        wait: true
        timeout: 600
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      when: not ansible_check_mode

    # -------------------------------------------------------------------------
    # 3) Localhost inventory + host
    # -------------------------------------------------------------------------
    - name: Ensure Localhost inventory exists
      awx.awx.inventory:
        name: "{{ localhost_inventory_name }}"
        organization: "{{ target_org_name }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"

    - name: Ensure localhost host exists (local connection)
      awx.awx.host:
        name: "{{ localhost_host_name }}"
        inventory: "{{ localhost_inventory_name }}"
        state: present
        variables: "{{ localhost_host_vars }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"

    # -------------------------------------------------------------------------
    # 4) Optional Azure SP credential (Azure Resource Manager)
    # -------------------------------------------------------------------------
    - name: Determine if Azure SP inputs are complete
      ansible.builtin.set_fact:
        azure_arm_ready: >-
          {{
            (create_azure_sp | bool)
            and (azure_subscription_id | length > 0)
            and (azure_tenant | length > 0)
            and (azure_client_id | length > 0)
            and (azure_client_secret | length > 0)
          }}

    - name: Warn if create_azure_sp=true but required fields are missing (skip instead of fail)
      ansible.builtin.debug:
       msg:
         - "Azure SP creation was requested (create_azure_sp=true) but required fields are missing."
         - "Skipping Azure credential creation for now."
         - "Missing: azure_subscription_id, azure_tenant, azure_client_id, azure_client_secret"
      when:
        - create_azure_sp | bool
        - not azure_arm_ready | bool

    - name: Force Azure SP creation toggle off when inputs are incomplete
      ansible.builtin.set_fact:
        azure_arm_ready: false
      when:
        - create_azure_sp | bool
        - not azure_arm_ready | bool

    - name: Create/Update Azure ARM credential (Azure-SP-Prod)
      awx.awx.credential:
        name: "{{ azure_arm_cred_name }}"
        organization: "{{ target_org_name }}"
        credential_type: "Microsoft Azure Resource Manager"
        state: present
        inputs:
          subscription: "{{ azure_subscription_id }}"
          tenant: "{{ azure_tenant }}"
          client: "{{ azure_client_id }}"
          secret: "{{ azure_client_secret }}"
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ controller_validate_certs }}"
      when: azure_arm_ready | bool

    # -------------------------------------------------------------------------
    # Summary
    # -------------------------------------------------------------------------
    - name: Bootstrap summary
      ansible.builtin.debug:
        msg:
          - "Org bootstrap completed for '{{ target_org_name }}'."
          - "Project ensured: {{ shared_project_name }} (branch={{ shared_project_scm_branch }})"
          - "Inventory ensured: {{ localhost_inventory_name }} (host={{ localhost_host_name }})"
          - "Azure SP requested: {{ create_azure_sp | bool }}"
          - "Azure SP created/updated: {{ azure_arm_ready | bool }}"
          - "Azure credential name: {{ azure_arm_cred_name }}"