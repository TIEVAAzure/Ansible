---
# ============================================================================
# _copy_one_template.yml
#
# Called by: Copy Org Job Templates + Surveys playbook (include_tasks + loop)
# Item shape: (jt_details_result, jt_survey_result)
#   item.0.json == full job template detail
#   item.1      == survey_spec GET response (status 200 or 404)
#
# URI-only (ansible.builtin.uri). No awx.awx / tower_* modules required.
# ============================================================================

- name: Map loop item to expected variables
  ansible.builtin.set_fact:
    detail: "{{ item.0.json }}"
    survey_rsp: "{{ item.1 }}"

- name: Set per-template working vars
  ansible.builtin.set_fact:
    src_name: "{{ detail.name }}"
    src_inv_name: "{{ detail.summary_fields.inventory.name | default('') }}"

    # Credentials referenced by source template (names)
    src_cred_names: "{{ (detail.summary_fields.credentials | default([])) | map(attribute='name') | list }}"
    missing_cred_names: "{{ src_cred_names | reject('in', (dst_cred_map.keys() | list)) | list }}"
    matched_cred_ids: "{{ src_cred_names | reject('in', missing_cred_names) | map('extract', dst_cred_map) | list }}"

    # If template uses the expected localhost inventory in source, map it to target localhost inventory.
    mapped_inventory_id: >-
      {{
        (src_inv_name == source_localhost_inventory_name)
        | ternary(target_localhost_inventory_id, none)
      }}

- name: Track missing creds (if any)
  ansible.builtin.set_fact:
    templates_missing_creds: "{{ templates_missing_creds | combine({ src_name: missing_cred_names }) }}"
  when: (missing_cred_names | length) > 0

- name: Track inventory not mapped (non-localhost inventory)
  ansible.builtin.set_fact:
    templates_inventory_not_mapped: "{{ templates_inventory_not_mapped + [src_name] }}"
  when:
    - allow_only_localhost_inventory_mapping | bool
    - (src_inv_name | length) > 0
    - (src_inv_name != source_localhost_inventory_name)

- name: Decide if we should skip due to missing creds
  ansible.builtin.set_fact:
    skip_due_to_missing_creds: >-
      {{
        (not create_templates_without_missing_creds | bool)
        and ((missing_cred_names | length) > 0)
      }}

- name: Mark skipped (missing creds and policy says skip)
  ansible.builtin.set_fact:
    skipped_templates: "{{ skipped_templates + [src_name] }}"
  when: skip_due_to_missing_creds | bool

# ---------------------------------------------------------------------------
# Build payload (only if we're not skipping)
# ---------------------------------------------------------------------------
- name: Build create/update payload for target template
  ansible.builtin.set_fact:
    jt_payload: >-
      {{
        {
          "name": detail.name,
          "description": (detail.description | default("")),
          "organization": target_org_id,
          "project": target_project_id,
          "playbook": detail.playbook,
          "job_type": (detail.job_type | default("run")),
          "become_enabled": (detail.become_enabled | default(false)),
          "diff_mode": (detail.diff_mode | default(false)),
          "allow_simultaneous": (detail.allow_simultaneous | default(false)),
          "ask_credential_on_launch": (detail.ask_credential_on_launch | default(false)),
          "ask_inventory_on_launch": (detail.ask_inventory_on_launch | default(false)),
          "ask_variables_on_launch": (detail.ask_variables_on_launch | default(false)),
          "ask_limit_on_launch": (detail.ask_limit_on_launch | default(false)),
          "ask_tags_on_launch": (detail.ask_tags_on_launch | default(false)),
          "ask_skip_tags_on_launch": (detail.ask_skip_tags_on_launch | default(false)),
          "ask_job_type_on_launch": (detail.ask_job_type_on_launch | default(false)),
          "ask_verbosity_on_launch": (detail.ask_verbosity_on_launch | default(false)),
          "ask_diff_mode_on_launch": (detail.ask_diff_mode_on_launch | default(false)),
          "job_tags": (detail.job_tags | default("")),
          "skip_tags": (detail.skip_tags | default("")),
          "limit": (detail.limit | default("")),
          "verbosity": (detail.verbosity | default(0)),
          "extra_vars": (detail.extra_vars | default(""))
        }
        | combine(
            (
              (allow_only_localhost_inventory_mapping | bool)
              | ternary(
                  (mapped_inventory_id is not none) | ternary({"inventory": mapped_inventory_id}, {}),
                  {}
                )
            )
          )
      }}
  when: not (skip_due_to_missing_creds | bool)

- name: Lookup existing target template by org + name
  ansible.builtin.uri:
    url: "{{ awx_api_base }}/job_templates/?organization={{ target_org_id }}&name={{ src_name | urlencode }}"
    method: GET
    headers: "{{ awx_headers }}"
    validate_certs: "{{ tower_verify_ssl }}"
    return_content: true
  register: tgt_lookup
  when: not (skip_due_to_missing_creds | bool)

- name: Guard - target lookup is sane (0 or 1 results only)
  ansible.builtin.assert:
    that:
      - (tgt_lookup.json.count | int) in [0, 1]
    fail_msg: >
      Found multiple templates named '{{ src_name }}' in target org. Clean up duplicates before copying.
  when: not (skip_due_to_missing_creds | bool)

- name: Create target template (if missing)
  ansible.builtin.uri:
    url: "{{ awx_api_base }}/job_templates/"
    method: POST
    headers: "{{ awx_headers }}"
    validate_certs: "{{ tower_verify_ssl }}"
    body_format: json
    body: "{{ jt_payload }}"
    status_code: [201]
    return_content: true
  register: tgt_create
  when:
    - not (skip_due_to_missing_creds | bool)
    - (tgt_lookup.json.count | int) == 0

- name: Update target template (if exists)
  ansible.builtin.uri:
    url: "{{ awx_api_base }}/job_templates/{{ tgt_lookup.json.results[0].id }}/"
    method: PATCH
    headers: "{{ awx_headers }}"
    validate_certs: "{{ tower_verify_ssl }}"
    body_format: json
    body: "{{ jt_payload }}"
    status_code: [200]
    return_content: true
  register: tgt_update
  when:
    - not (skip_due_to_missing_creds | bool)
    - (tgt_lookup.json.count | int) == 1

- name: Set target template id
  ansible.builtin.set_fact:
    target_jt_id: >-
      {{
        ((tgt_lookup.json.count | int) == 1)
        | ternary(tgt_lookup.json.results[0].id, tgt_create.json.id)
      }}
  when: not (skip_due_to_missing_creds | bool)

# ---------------------------------------------------------------------------
# Apply survey + credentials
# ---------------------------------------------------------------------------
- name: Apply survey spec (only if source has one)
  ansible.builtin.uri:
    url: "{{ awx_api_base }}/job_templates/{{ target_jt_id }}/survey_spec/"
    method: POST
    headers: "{{ awx_headers }}"
    validate_certs: "{{ tower_verify_ssl }}"
    body_format: json
    body: "{{ survey_rsp.json }}"
    status_code: [200, 201]
    return_content: true
  when:
    - not (skip_due_to_missing_creds | bool)
    - survey_rsp is defined
    - (survey_rsp.status | int) == 200
    - survey_rsp.json is mapping

- name: Attach credentials (only those that exist in target)
  ansible.builtin.uri:
    url: "{{ awx_api_base }}/job_templates/{{ target_jt_id }}/credentials/"
    method: POST
    headers: "{{ awx_headers }}"
    validate_certs: "{{ tower_verify_ssl }}"
    body_format: json
    body:
      id: "{{ cred_id }}"
    status_code: [204]
    return_content: false
  loop: "{{ matched_cred_ids }}"
  loop_control:
    loop_var: cred_id
  when:
    - not (skip_due_to_missing_creds | bool)
    - (matched_cred_ids | length) > 0

- name: Mark template copied
  ansible.builtin.set_fact:
    copied_templates: "{{ copied_templates + [src_name] }}"
  when: not (skip_due_to_missing_creds | bool)
