---
- name: Create a Windows Server VM in existing RG
  hosts: localhost
  connection: local
  collections:
    - azure.azcollection

  vars:
    # Core settings (defaults - usually overridden by AWX survey)
    resource_group: rg-mg-learn-uksouth-001
    location: uksouth

    vm_name: ansible-test

    # NIC name derived from the VM name to keep things consistent
    nic_name: "nic-win-{{ vm_name }}"

    # Existing virtual network and subnet
    vnet_name: GILO-DC-01-vnet      # existing VNet
    subnet_name: default            # existing subnet

    # Local admin account on the VM
    admin_username: azureuser
    admin_password: "P@ssw0rd1234!!"   # override via AWX credential/survey

    # VM sizing and image
    vm_size: Standard_D2as_v5
    sku: 2022-datacenter

    disk_size_gb: 128
    managed_disk_type: Premium_LRS

    # Behaviour toggles
    vm_state: present                        # keep as "present" in this play

    enable_accelerated_networking: false     # true / false

    public_ip_mode: "none"                   # "none" or "new"
    nsg_mode: "none"                         # "none" or "basic"

    # Shared defaults with delete playbook (used when state=absent there)
    delete_os_disk_with_vm: true
    delete_nic_with_vm: true

  tasks:

    - name: Check if VM already exists
      azure.azcollection.azure_rm_virtualmachine_info:
        resource_group: "{{ resource_group }}"
        name: "{{ vm_name }}"
      register: vm_info
      failed_when: false

    - name: Fail when VM already exists (create-only behaviour)
      ansible.builtin.fail:
        msg: "VM {{ vm_name }} already exists in {{ resource_group }}. Aborting to avoid accidental update."
      when: (vm_info.vms | default([])) | length > 0

    # -----------------------------
    # Optional network extras
    # -----------------------------

    # Optional network extras
    - name: Create public IP for VM (optional)
      azure.azcollection.azure_rm_publicipaddress:
        resource_group: "{{ resource_group }}"
        name: "{{ vm_name }}-pip"
        allocation_method: Static
        sku: Standard
        state: present
      when: public_ip_mode == "new" and vm_state == "present"

    - name: Ensure NSG exists (empty by default)
      azure.azcollection.azure_rm_securitygroup:
        resource_group: "{{ resource_group }}"
        name: "{{ vm_name }}-nsg"
        location: "{{ location }}"
        state: present
      when: nsg_mode == "basic" and vm_state == "present"

    # NIC with no NSG and no PIP
    - name: Ensure NIC without NSG or PIP exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ resource_group }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        ip_configurations:
          - name: ipconfig1
        state: present
      when: vm_state == "present" and public_ip_mode == "none" and nsg_mode == "none"

    # NIC with PIP only
    - name: Ensure NIC with PIP only exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ resource_group }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        ip_configurations:
          - name: ipconfig1
            public_ip_address_name: "{{ vm_name }}-pip"
        state: present
      when: vm_state == "present" and public_ip_mode == "new" and nsg_mode == "none"

    # NIC with NSG only
    - name: Ensure NIC with NSG only exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ resource_group }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        security_group: "{{ vm_name }}-nsg"
        ip_configurations:
          - name: ipconfig1
        state: present
      when: vm_state == "present" and public_ip_mode == "none" and nsg_mode == "basic"

    # NIC with NSG and PIP
    - name: Ensure NIC with NSG and PIP exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ resource_group }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        security_group: "{{ vm_name }}-nsg"
        ip_configurations:
          - name: ipconfig1
            public_ip_address_name: "{{ vm_name }}-pip"
        state: present
      when: vm_state == "present" and public_ip_mode == "new" and nsg_mode == "basic"

    # -----------------------------
    # VM creation
    # -----------------------------

    - name: Ensure Windows VM is present
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ resource_group }}"
        name: "{{ vm_name }}"
        location: "{{ location }}"

        admin_username: "{{ admin_username }}"
        admin_password: "{{ admin_password }}"
        network_interfaces: "{{ nic_name }}"
        vm_size: "{{ vm_size }}"
        os_type: Windows

        managed_disk_type: "{{ managed_disk_type }}"
        os_disk_size_gb: "{{ disk_size_gb }}"

        image:
          offer: WindowsServer
          publisher: MicrosoftWindowsServer
          sku: "{{ sku }}"
          version: latest

        state: "{{ vm_state }}"
