---
# AZ â€“ Create Storage Account
# - Ensures a Storage Account exists (idempotent)
# - Auth: azure.azcollection via AWX Azure credential
# - Naming: Storage account name must be 3-24 chars, lowercase letters and numbers only

- name: Create Storage Account
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  vars:
    # AWX survey variables
    rg_name: ""
    sa_name: ""
    location: ""
    sa_sku: "Standard_LRS"   # safe default
    sa_kind: "StorageV2"     # safe default

  tasks:
    - name: Guard | Validate required inputs
      ansible.builtin.assert:
        that:
          - rg_name | trim | length > 2
          - sa_name | trim | length > 2
          - sa_name is match("^[a-z0-9]{3,24}$")
          - location | trim | length > 2
          - sa_sku in ["Standard_LRS","Standard_GRS","Standard_RAGRS","Standard_ZRS","Premium_LRS"]
          - sa_kind in ["StorageV2","Storage","BlobStorage","FileStorage","BlockBlobStorage"]

        fail_msg: >
          Missing required inputs or invalid storage account name.
          Ensure rg_name, sa_name, location, sa_sku and sa_kind are provided via the AWX Survey.
          Storage account names must be 3-24 chars, lowercase letters and numbers only.

    - name: Ensure storage account exists
      azure_rm_storageaccount:
        resource_group: "{{ rg_name }}"
        name: "{{ sa_name }}"
        location: "{{ location }}"
        account_type: "{{ sa_sku }}"
        kind: "{{ sa_kind }}"
        https_only: true
        state: present