---
# AZ - Create Windows VM
# - Create-only play: fails if the VM already exists to avoid accidental updates
# - Optional toggles: create Public IP, create basic NSG, and wire them to the NIC
# - Auth: azure.azcollection via AWX Azure credential (no Azure CLI required)
#
# Security note:
#   Do not commit real passwords. Supply admin_password via AWX Survey (secret)
#   or a credential, and consider using Key Vault in more mature setups.

- name: Create a Windows Server VM in existing RG
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # Toggle to prevent secrets (like admin_password) from being printed in job output
    hide_secrets: "{{ hide_secrets | default(true) }}"

    # Core settings (defaults - usually overridden by AWX survey)
    rg_name: ""
    location: ""

    vm_name: ""

    # NIC name derived from the VM name to keep things consistent
    nic_name: "nic-win-{{ vm_name }}"

    # Existing virtual network and subnet
    vnet_name: ""      # existing VNet
    subnet_name: ""            # existing subnet

    # Local admin account on the VM
    admin_username: ""
    admin_password: ""   # override via AWX credential/survey

    # VM sizing and image
    vm_size: ""
    sku: ""

    disk_size_gb: ""
    managed_disk_type: ""

    # Behaviour toggles
    vm_state: present                        # keep as "present" in this play

    enable_accelerated_networking: false     # true / false

    public_ip_mode: "none"                   # "none" or "new"
    nsg_mode: "none"                         # "none" or "basic"

    # Shared defaults with delete playbook (used when state=absent there)
    delete_os_disk_with_vm: true
    delete_nic_with_vm: true

  tasks:

    - name: Guard | Validate required inputs and safe choices
      ansible.builtin.assert:
        that:
          - rg_name is defined and (rg_name | string | length) > 2
          - location is defined and (location | string | length) > 2
          - vm_name is defined and (vm_name | string | length) > 1
          - vnet_name is defined and (vnet_name | string | length) > 1
          - subnet_name is defined and (subnet_name | string | length) > 1
          - vm_state | lower == "present"
          - public_ip_mode | lower in ["none", "new"]
          - nsg_mode | lower in ["none", "basic"]
          - admin_username is defined and (admin_username | string | length) > 1
          - admin_password is defined and (admin_password | string | length) >= 10
        fail_msg: >
          Missing required variables or invalid options. In AWX, provide values via Survey and store admin_password as a secret.



    - name: Check if VM already exists
      azure.azcollection.azure_rm_virtualmachine_info:
        resource_group: "{{ rg_name }}"
        name: "{{ vm_name }}"
      register: vm_info
      failed_when: false

    - name: Fail when VM already exists (create-only behaviour)
      ansible.builtin.fail:
        msg: "VM {{ vm_name }} already exists in {{ rg_name }}. Aborting to avoid accidental update."
      when: (vm_info.vms | default([])) | length > 0

    # -----------------------------
    # Optional network extras
    # -----------------------------

    # Optional network extras
    - name: Create public IP for VM (optional)
      azure.azcollection.azure_rm_publicipaddress:
        resource_group: "{{ rg_name }}"
        name: "{{ vm_name }}-pip"
        allocation_method: Static
        sku: Standard
        state: present
      when: public_ip_mode == "new" and vm_state == "present"

    - name: Ensure NSG exists (empty by default)
      azure.azcollection.azure_rm_securitygroup:
        resource_group: "{{ rg_name }}"
        name: "{{ vm_name }}-nsg"
        location: "{{ location }}"
        state: present
      when: nsg_mode == "basic" and vm_state == "present"

    # NIC with no NSG and no PIP
    - name: Ensure NIC without NSG or PIP exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        ip_configurations:
          - name: ipconfig1
        state: present
      when: vm_state == "present" and public_ip_mode == "none" and nsg_mode == "none"

    # NIC with PIP only
    - name: Ensure NIC with PIP only exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        ip_configurations:
          - name: ipconfig1
            public_ip_address_name: "{{ vm_name }}-pip"
        state: present
      when: vm_state == "present" and public_ip_mode == "new" and nsg_mode == "none"

    # NIC with NSG only
    - name: Ensure NIC with NSG only exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        security_group: "{{ vm_name }}-nsg"
        ip_configurations:
          - name: ipconfig1
        state: present
      when: vm_state == "present" and public_ip_mode == "none" and nsg_mode == "basic"

    # NIC with NSG and PIP
    - name: Ensure NIC with NSG and PIP exists
      azure.azcollection.azure_rm_networkinterface:
        resource_group: "{{ rg_name }}"
        name: "{{ nic_name }}"
        virtual_network: "{{ vnet_name }}"
        subnet_name: "{{ subnet_name }}"
        enable_accelerated_networking: "{{ enable_accelerated_networking | bool }}"
        security_group: "{{ vm_name }}-nsg"
        ip_configurations:
          - name: ipconfig1
            public_ip_address_name: "{{ vm_name }}-pip"
        state: present
      when: vm_state == "present" and public_ip_mode == "new" and nsg_mode == "basic"

    # -----------------------------
    # VM creation
    # -----------------------------

    - name: Ensure Windows VM is present
      no_log: "{{ hide_secrets | bool }}"
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ vm_name }}"
        location: "{{ location }}"

        admin_username: "{{ admin_username }}"
        admin_password: "{{ admin_password }}"
        network_interfaces: "{{ nic_name }}"
        vm_size: "{{ vm_size }}"
        os_type: Windows

        managed_disk_type: "{{ managed_disk_type }}"
        os_disk_size_gb: "{{ disk_size_gb }}"

        image:
          offer: WindowsServer
          publisher: MicrosoftWindowsServer
          sku: "{{ sku }}"
          version: latest

        state: "{{ vm_state }}"
