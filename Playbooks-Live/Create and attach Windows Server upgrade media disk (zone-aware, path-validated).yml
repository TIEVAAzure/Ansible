---
- name: Create and attach Windows Server upgrade media disk (zone-aware, path-validated, using az CLI)
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  vars:
    rg_name: ""        # Resource group of the VM
    vm_name: ""        # Name of the VM to upgrade

    # Current OS version:
    #   2012R2, 2016, 2019, 2022
    source_os: ""

    # Target upgrade SKU (WindowsServerUpgrade image SKU):
    #   server2016Upgrade, server2019Upgrade, server2022Upgrade, server2025Upgrade
    upgrade_sku: "server2019Upgrade"

    # Disk name for the upgrade media
    upgrade_disk_name: "ws-upgrade-{{ vm_name }}"

    # Managed disk SKU for the upgrade disk
    upgrade_disk_sku: "Standard_LRS"

    valid_upgrade_paths:
      "2012R2":
        - server2016Upgrade
        - server2019Upgrade
        - server2025Upgrade
      "2016":
        - server2019Upgrade
        - server2022Upgrade
        - server2025Upgrade
      "2019":
        - server2022Upgrade
        - server2025Upgrade
      "2022":
        - server2025Upgrade

  tasks:
# 0) Log in to Azure CLI using the same SP as azure.azcollection
    - name: Read Azure credential env vars
      ansible.builtin.set_fact:
        azure_client_id: "{{ lookup('env', 'AZURE_CLIENT_ID') }}"
        azure_client_secret: "{{ lookup('env', 'AZURE_SECRET') }}"
        azure_tenant_id: "{{ lookup('env', 'AZURE_TENANT') }}"
        azure_subscription_id: "{{ lookup('env', 'AZURE_SUBSCRIPTION_ID') }}"

    - name: Ensure Azure env vars are present
      ansible.builtin.assert:
        that:
          - azure_client_id | length > 0
          - azure_client_secret | length > 0
          - azure_tenant_id | length > 0
          - azure_subscription_id | length > 0
        fail_msg: >
          Missing one or more Azure env vars (AZURE_CLIENT_ID / AZURE_SECRET / AZURE_TENANT / AZURE_SUBSCRIPTION_ID).
          Check your AWX Azure credential configuration.

    - name: az login with service principal
      ansible.builtin.command: >
        az login
        --service-principal
        -u {{ azure_client_id }}
        -p {{ azure_client_secret }}
        --tenant {{ azure_tenant_id }}
        --output none
      no_log: true
      changed_when: false

    - name: Set az subscription
      ansible.builtin.command: >
        az account set --subscription {{ azure_subscription_id }}
      changed_when: false
    # 1) Validate upgrade path
    - name: Validate requested upgrade path
      ansible.builtin.assert:
        that:
          - source_os in valid_upgrade_paths
          - upgrade_sku in valid_upgrade_paths[source_os]
        fail_msg: >
          Unsupported upgrade path: {{ source_os }} -> {{ upgrade_sku }}.
          Allowed targets for {{ source_os }} are:
          {{ valid_upgrade_paths[source_os] | join(', ') }}.

    # 2) Get VM info
    - name: Get VM info
      azure.azcollection.azure_rm_virtualmachine_info:
        resource_group: "{{ rg_name }}"
        name: "{{ vm_name }}"
      register: vm_info

    - name: Fail if VM not found
      ansible.builtin.fail:
        msg: "VM '{{ vm_name }}' not found in resource group '{{ rg_name }}'."
      when: >
        ((vm_info.vms | default([])) | length == 0) and
        ((vm_info.virtual_machines | default([])) | length == 0)

    - name: Normalise VM object
      ansible.builtin.set_fact:
        vm_obj: >-
          {{
            (vm_info.vms | default([]) | first)
            if (vm_info.vms | default([]) | length > 0)
            else (vm_info.virtual_machines | default([]) | first)
          }}

    - name: Extract VM location, zone and data disk LUNs
      ansible.builtin.set_fact:
        vm_location: "{{ vm_obj.location }}"
        vm_zones: "{{ vm_obj.zones | default([]) }}"
        existing_luns: >-
          {{ (vm_obj.storage_profile.data_disks | default([]))
             | map(attribute='lun') | list }}

    - name: Determine VM primary zone (if any)
      ansible.builtin.set_fact:
        vm_zone: "{{ vm_zones[0] if vm_zones | length > 0 else None }}"

    - name: Show VM location and zone
      ansible.builtin.debug:
        msg: >
          VM '{{ vm_name }}' is in '{{ vm_location }}',
          zone: {{ vm_zone | default('None (no-zone VM)') }}.

    # 3) Build zone arg list for az
    - name: Build zone argument list for az disk create
      ansible.builtin.set_fact:
        zone_args: "{{ ['--zone', vm_zone] if (vm_zone is not none and (vm_zone | string | length) > 0) else [] }}"

    # 4) Build full argv list for az disk create
    - name: Build argv for az disk create
      ansible.builtin.set_fact:
        az_disk_create_argv: >-
          {{
            ['az', 'disk', 'create',
             '-g', rg_name,
             '-n', upgrade_disk_name,
             '-l', vm_location]
            + zone_args
            + ['--sku', upgrade_disk_sku,
               '--image-reference',
               'MicrosoftWindowsServer:WindowsServerUpgrade:' ~ upgrade_sku ~ ':latest',
               '-o', 'json']
          }}

    - name: Show az disk create argv
      ansible.builtin.debug:
        var: az_disk_create_argv

    # 5) Create Windows Server upgrade media disk via az CLI
    - name: Create Windows Server upgrade media disk via az CLI
      ansible.builtin.command:
        argv: "{{ az_disk_create_argv }}"
      register: create_disk_cmd
      changed_when: "'Succeeded' in create_disk_cmd.stdout or 'provisioningState\"' in (create_disk_cmd.stdout | default(''))"


    - name: Show disk creation output
      ansible.builtin.debug:
        var: create_disk_cmd.stdout

    # 6) Choose free LUN
    - name: Choose next free LUN
      ansible.builtin.set_fact:
        upgrade_lun: "{{ (existing_luns | max + 1) if (existing_luns | length > 0) else 0 }}"

    - name: Show chosen LUN
      ansible.builtin.debug:
        msg: "Upgrade disk will attach on LUN {{ upgrade_lun }}."

    # 7) Attach upgrade disk
    - name: Attach upgrade disk to VM
      azure.azcollection.azure_rm_manageddisk:
        resource_group: "{{ rg_name }}"
        name: "{{ upgrade_disk_name }}"
        managed_by: "{{ vm_name }}"
        lun: "{{ upgrade_lun }}"
        state: present
      register: attach_result

    - name: Confirm upgrade disk attached
      ansible.builtin.debug:
        msg: >
          Upgrade disk '{{ upgrade_disk_name }}' attached to VM '{{ vm_name }}'
          on LUN {{ upgrade_lun }} (Zone={{ vm_zone | default('None') }}).
