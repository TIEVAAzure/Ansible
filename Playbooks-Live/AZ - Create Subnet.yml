---
# AZ â€“ Create Subnet
# - Ensures a subnet exists in an existing VNet (idempotent)
# - Auth: azure.azcollection via AWX Azure credential

- name: Create Subnet
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  vars:
    # AWX survey variables
    rg_name: ""
    vnet_name: ""
    subnet_name: ""
    subnet_prefix: ""

  tasks:
    - name: Guard | Validate required inputs
      ansible.builtin.assert:
        that:
          - rg_name | trim | length > 2
          - vnet_name | trim | length > 2
          - subnet_name | trim | length > 2
          - subnet_prefix | trim | length > 6
        fail_msg: >
          Missing required inputs.
          Ensure rg_name, vnet_name, subnet_name and subnet_prefix
          are provided via the AWX Survey.

    - name: Ensure subnet exists
      azure_rm_subnet:
        resource_group: "{{ rg_name }}"
        virtual_network_name: "{{ vnet_name }}"
        name: "{{ subnet_name }}"
        address_prefix: "{{ subnet_prefix }}"
        state: present