---
- name: Manage Azure VM power state (Start / Stop / Restart)
  hosts: localhost
  connection: local
  gather_facts: false

  # In AWX you'll normally override these via a Survey:
  # - rg_name      -> text field
  # - vm_action    -> choice (start|stop|restart)
  # - azure_vm_names -> multi-line text (one VM name per line)
  vars:
    rg_name: ""
    vm_action: ""
    azure_vm_names: ""   # e.g. "vm1\nvm2\nvm3"

  tasks:
    - name: Build VM list from newline-separated survey input
      set_fact:
        vm_list: >-
          {{ azure_vm_names.splitlines()
             | map('trim')
             | reject('equalto', '')
             | list }}

    - name: Show selected VMs and action
      debug:
        msg:
          - "Resource group: {{ rg_name }}"
          - "Action: {{ vm_action }}"
          - "VMs: {{ vm_list | join(', ') }}"

    - name: START VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        started: true
      loop: "{{ vm_list }}"
      when: vm_action | lower == 'start'

    - name: STOP (deallocate) VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        started: false          # power off
        allocated: false        # deallocate so you stop paying compute
      loop: "{{ vm_list }}"
      when: vm_action | lower in ['stop', 'deallocate', 'stopped']

    - name: RESTART VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        restarted: true
      loop: "{{ vm_list }}"
      when: vm_action | lower in ['restart', 'reboot']
