---
# AZ - Manage Azure VM power state
# - Start / Stop(deallocate) / Restart a list of VMs in the same RG
# - Input: newline-separated VM names (AWX multi-line survey field works well)
# - Auth: azure.azcollection via AWX Azure credential

- name: Manage Azure VM power state (Start / Stop / Restart)
  hosts: localhost
  connection: local
  gather_facts: false

  collections:
    - azure.azcollection

  # In AWX you'll normally override these via a Survey:
  # - rg_name         -> text field
  # - vm_action       -> choice (start|stop|restart)
  # - azure_vm_names  -> multi-line text (one VM name per line)
  vars:
    rg_name: ""
    vm_action: ""
    azure_vm_names: ""   # e.g. "vm1\nvm2\nvm3"

  tasks:
    - name: Build VM list from newline-separated survey input
      ansible.builtin.set_fact:
        vm_list: >-
          {{ (azure_vm_names | default('')).splitlines()
             | map('trim')
             | reject('equalto', '')
             | list }}

    - name: Guard | Validate action and VM list
      ansible.builtin.assert:
        that:
          - rg_name | trim | length > 2
          - vm_action | trim | length > 0
          - (vm_action | lower) in ["start", "stop", "deallocate", "stopped", "restart", "reboot"]
          - vm_list | length > 0
        fail_msg: >
          Missing required inputs or invalid action.
          Provide rg_name, a valid vm_action, and at least one VM name (one per line).

    - name: Show selected VMs and action
      ansible.builtin.debug:
        msg:
          - "Resource group: {{ rg_name }}"
          - "Action: {{ vm_action | lower }}"
          - "VMs: {{ vm_list | join(', ') }}"

    - name: START VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        started: true
      loop: "{{ vm_list }}"
      when: (vm_action | lower) == "start"

    - name: STOP (deallocate) VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        started: false          # power off
        allocated: false        # deallocate so you stop paying compute
      loop: "{{ vm_list }}"
      when: (vm_action | lower) in ["stop", "deallocate", "stopped"]

    - name: RESTART VMs
      azure.azcollection.azure_rm_virtualmachine:
        resource_group: "{{ rg_name }}"
        name: "{{ item }}"
        state: present
        restarted: true
      loop: "{{ vm_list }}"
      when: (vm_action | lower) in ["restart", "reboot"]