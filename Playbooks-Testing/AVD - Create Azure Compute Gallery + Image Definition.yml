---
# -------------------------------------------------------------------
# This playbook creates:
#   1) Azure Compute Gallery (image library)
#   2) Image Definition (image "slot" that versions get published into)
#
# Run this ONCE per environment / image family.
# Quarterly builds will publish versions into the image definition.
# -------------------------------------------------------------------

- name: Create Azure Compute Gallery + Image Definition (DEV)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # Optional if AWX is already scoped to the correct subscription,
    # but good to keep in multi-sub environments.
    subscription_id: "PUT-SUB-ID-HERE"

    # Resource group for the gallery
    rg_name: "rg-mg-learn-uksouth-001"

    # Region
    location: "uksouth"

    # Compute Gallery name (library)
    gallery_name: "acg-avd-dev"

    # Image Definition name (versions publish here)
    image_definition_name: "avd-win11ms-standard"

    # Metadata only (helps you identify images later)
    image_publisher: "Cloud Ops TIEVA"
    image_offer: "AVD-Standard"
    image_sku: "win11-multisession"

    # Win11 requires Gen2
    hyper_v_generation: "V2"

  tasks:
    # ---------------------------------------------------------------
    # TASK 1: Create the Compute Gallery
    # NOTE: provider must be 'Compute' (NOT 'Microsoft.Compute')
    # ---------------------------------------------------------------
    - name: Create Compute Gallery
      azure_rm_resource:
        subscription_id: "{{ subscription_id }}"
        resource_group: "{{ rg_name }}"
        provider: "Compute"
        resource_type: "galleries"
        resource_name: "{{ gallery_name }}"
        api_version: "2023-07-03"
        body:
          location: "{{ location }}"

    # ---------------------------------------------------------------
    # TASK 2: Create the Image Definition in the gallery
    # NOTE: provider must be 'Compute' (NOT 'Microsoft.Compute')
    # resource_type galleries/images = child resource under the gallery
    # ---------------------------------------------------------------
    - name: Create Image Definition
      azure_rm_resource:
        subscription_id: "{{ subscription_id }}"
        resource_group: "{{ rg_name }}"
        provider: "Compute"
        resource_type: "galleries/images"
        resource_name: "{{ gallery_name }}/{{ image_definition_name }}"
        api_version: "2023-07-03"
        body:
          location: "{{ location }}"
          properties:
            osType: "Windows"
            osState: "Generalized"
            hyperVGeneration: "{{ hyper_v_generation }}"
            identifier:
              publisher: "{{ image_publisher }}"
              offer: "{{ image_offer }}"
              sku: "{{ image_sku }}"

    # ---------------------------------------------------------------
    # TASK 3: Confirmation output
    # ---------------------------------------------------------------
    - name: Output gallery and image definition names
      ansible.builtin.debug:
        msg:
          - "Compute Gallery created (or already exists): {{ gallery_name }}"
          - "Image Definition created (or already exists): {{ image_definition_name }}"
