---
# -------------------------------------------------------------------
# Creates:
#   1) Azure Compute Gallery (image library)
#   2) Gallery Image Definition (image "slot" for versions)
#
# This is ONE-TIME setup in DEV.
# -------------------------------------------------------------------

- name: Create Azure Compute Gallery + Image Definition (DEV)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # Subscription is optional if AWX creds are correctly scoped,
    # but leaving it in is safer if you manage multiple subs.
    subscription_id: "PUT-SUB-ID-HERE"

    rg_name: "rg-mg-learn-uksouth-001"
    location: "uksouth"

    # IMPORTANT: Gallery name cannot include dashes
    gallery_name: "acg_avd_dev"

    # Image definition name (keep simple)
    image_definition_name: "avd_win11ms_standard"

    # Metadata only (helps identify images later)
    image_publisher: "Cloud Ops TIEVA"
    image_offer: "AVD-Standard"
    image_sku: "win11-multisession"

    # Win11 requires Gen2
    hyper_v_generation: "V2"

  tasks:
    # ---------------------------------------------------------------
    # TASK 1: Create the Compute Gallery
    # ---------------------------------------------------------------
    - name: Ensure Compute Gallery exists
      azure_rm_gallery:
        subscription_id: "{{ subscription_id }}"
        resource_group: "{{ rg_name }}"
        name: "{{ gallery_name }}"
        location: "{{ location }}"
        state: present

    # ---------------------------------------------------------------
    # TASK 2: Create the Image Definition in the gallery
    # This is where AIB will publish versions
    # ---------------------------------------------------------------
    - name: Ensure Image Definition exists
      azure_rm_galleryimage:
        subscription_id: "{{ subscription_id }}"
        resource_group: "{{ rg_name }}"
        gallery_name: "{{ gallery_name }}"
        name: "{{ image_definition_name }}"
        location: "{{ location }}"
        os_type: Windows
        os_state: generalized
        hyper_v_generation: "{{ hyper_v_generation }}"
        identifier:
          publisher: "{{ image_publisher }}"
          offer: "{{ image_offer }}"
          sku: "{{ image_sku }}"
        state: present

    # ---------------------------------------------------------------
    # TASK 3: Confirmation output
    # ---------------------------------------------------------------
    - name: Output what was created
      ansible.builtin.debug:
        msg:
          - "Compute Gallery: {{ gallery_name }}"
          - "Image Definition: {{ image_definition_name }}"
          - "RG: {{ rg_name }} | Location: {{ location }}"
