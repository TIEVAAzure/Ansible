---
# -------------------------------------------------------------------
# STEP 1 (DEV): Create Azure Compute Gallery + Image Definition
#
# Why ARM deployment?
# - Your Control Plane EE's azure_rm_gallery is throwing KeyError('description')
# - azure_rm_resource has been awkward with nested types (galleries/images)
# - azure_rm_deployment uses a native ARM template and is very reliable
#
# This playbook is SAFE to re-run (idempotent via ARM).
# -------------------------------------------------------------------

- name: Create Azure Compute Gallery + Image Definition (DEV) - ARM deployment
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # Resource group where gallery + image definition will live
    rg_name: "rg-mg-learn-uksouth-001"
    location: "uksouth"

    # IMPORTANT: Gallery name cannot contain dashes
    gallery_name: "acg_avd_dev"

    # Keep this simple as well
    image_definition_name: "avd_win11ms_standard"

    # Metadata (informational only)
    image_publisher: "Cloud Ops TIEVA"
    image_offer: "AVD-Standard"
    image_sku: "win11-multisession"

    # Windows 11 = Gen2
    hyper_v_generation: "V2"

    # Name of the ARM deployment (any friendly name)
    deployment_name: "deploy-compute-gallery"

  tasks:
    # -------------------------------------------------------------------
    # Deploy ARM template containing:
    # - Microsoft.Compute/galleries
    # - Microsoft.Compute/galleries/images
    # -------------------------------------------------------------------
    - name: Deploy gallery + image definition
      azure_rm_deployment:
        resource_group: "{{ rg_name }}"
        location: "{{ location }}"
        name: "{{ deployment_name }}"
        state: present
        template:
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
          contentVersion: "1.0.0.0"
          parameters:
            location:
              type: string
            galleryName:
              type: string
            imageDefinitionName:
              type: string
            publisher:
              type: string
            offer:
              type: string
            sku:
              type: string
            hyperVGeneration:
              type: string
          resources:
            # ----------------------------
            # 1) Compute Gallery (library)
            # ----------------------------
            - type: "Microsoft.Compute/galleries"
              apiVersion: "2023-07-03"
              name: "[parameters('galleryName')]"
              location: "[parameters('location')]"
              properties: {}

            # ---------------------------------------
            # 2) Image Definition (slot for versions)
            # ---------------------------------------
            - type: "Microsoft.Compute/galleries/images"
              apiVersion: "2023-07-03"
              name: "[format('{0}/{1}', parameters('galleryName'), parameters('imageDefinitionName'))]"
              location: "[parameters('location')]"
              dependsOn:
                - "[resourceId('Microsoft.Compute/galleries', parameters('galleryName'))]"
              properties:
                osType: "Windows"
                osState: "Generalized"
                hyperVGeneration: "[parameters('hyperVGeneration')]"
                identifier:
                  publisher: "[parameters('publisher')]"
                  offer: "[parameters('offer')]"
                  sku: "[parameters('sku')]"
        parameters:
          location:
            value: "{{ location }}"
          galleryName:
            value: "{{ gallery_name }}"
          imageDefinitionName:
            value: "{{ image_definition_name }}"
          publisher:
            value: "{{ image_publisher }}"
          offer:
            value: "{{ image_offer }}"
          sku:
            value: "{{ image_sku }}"
          hyperVGeneration:
            value: "{{ hyper_v_generation }}"

    # -------------------------------------------------------------------
    # Friendly output
    # -------------------------------------------------------------------
    - name: Output result
      ansible.builtin.debug:
        msg:
          - "Compute Gallery ensured: {{ gallery_name }}"
          - "Image Definition ensured: {{ image_definition_name }}"
          - "RG: {{ rg_name }} | Location: {{ location }}"
