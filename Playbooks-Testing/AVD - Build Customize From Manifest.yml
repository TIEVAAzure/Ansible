---
- name: AIB - Build customize array from manifest (preview)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # inputs via AWX survey
    rg_name: "{{ rg_name }}"
    sa_name: "{{ sa_name }}"
    container_name: "{{ container_name }}"

    # You can pass either:
    # - a full repo-relative path e.g. Playbook-Templates/AIB-Build-Manifests/IMS/ims-avd-win11-2026-q1.yml
    # - OR just the filename e.g. ims-avd-win11-2026-q1.yml
    manifest_path: "{{ manifest_path }}"
    ms_builtins_map_path: "{{ ms_builtins_map_path }}"

    sas_valid_hours: 24

    # Where AWX checks out the repo
    project_dir: "{{ lookup('env', 'AWX_PROJECT_DIR') | default('/runner/project', true) }}"

    # AIB common flags
    ps_defaults:
      runAsSystem: true
      runElevated: true

    # Windows Update customizer defaults (tune later)
    windows_update_customizer:
      type: WindowsUpdate
      name: ApplyWindowsUpdates
      searchCriteria: "IsInstalled=0"
      filters:
        - "exclude:$_.Title -like '*Preview*'"
        - "exclude:$_.Title -like '*Beta*'"

  tasks:
    # ----------------------------
    # Normalize incoming survey paths (handle Windows \)
    # ----------------------------
    - name: Normalize survey paths (convert backslashes to forward slashes)
      ansible.builtin.set_fact:
        manifest_path_norm: "{{ manifest_path | replace('\\\\', '/') }}"
        builtins_path_norm: "{{ ms_builtins_map_path | replace('\\\\', '/') }}"
      changed_when: false

    # ----------------------------
    # Resolve manifest path
    # ----------------------------
    - name: Check manifest path as provided (repo-relative)
      ansible.builtin.stat:
        path: "{{ project_dir }}/{{ manifest_path_norm }}"
      register: st_manifest
      changed_when: false

    - name: Find manifest by filename if path not found
      ansible.builtin.find:
        paths: "{{ project_dir }}"
        patterns: "{{ manifest_path_norm | basename }}"
        file_type: file
        recurse: true
      register: find_manifest
      when: not st_manifest.stat.exists
      changed_when: false

    - name: Set resolved manifest path
      ansible.builtin.set_fact:
        manifest_resolved_path: >-
          {{
            (project_dir ~ '/' ~ manifest_path_norm)
            if st_manifest.stat.exists
            else
            (find_manifest.files[0].path if (find_manifest is defined and (find_manifest.matched | int) > 0) else '')
          }}
      changed_when: false

    - name: Fail if manifest still not found
      ansible.builtin.fail:
        msg: >-
          Manifest file not found.
          Tried: {{ project_dir }}/{{ manifest_path_norm }}
          Also searched for filename: {{ manifest_path_norm | basename }} under {{ project_dir }}.
          Fix: commit/push the manifest into the repo and ensure the AWX Project is synced.
      when: manifest_resolved_path | length == 0

    # ----------------------------
    # Resolve built-ins mapping path
    # ----------------------------
    - name: Check built-ins map path as provided (repo-relative)
      ansible.builtin.stat:
        path: "{{ project_dir }}/{{ builtins_path_norm }}"
      register: st_builtins
      changed_when: false

    - name: Find built-ins map by filename if path not found
      ansible.builtin.find:
        paths: "{{ project_dir }}"
        patterns: "{{ builtins_path_norm | basename }}"
        file_type: file
        recurse: true
      register: find_builtins
      when: not st_builtins.stat.exists
      changed_when: false

    - name: Set resolved built-ins map path
      ansible.builtin.set_fact:
        builtins_resolved_path: >-
          {{
            (project_dir ~ '/' ~ builtins_path_norm)
            if st_builtins.stat.exists
            else
            (find_builtins.files[0].path if (find_builtins is defined and (find_builtins.matched | int) > 0) else '')
          }}
      changed_when: false

    - name: Fail if built-ins map still not found
      ansible.builtin.fail:
        msg: >-
          Built-ins mapping file not found.
          Tried: {{ project_dir }}/{{ builtins_path_norm }}
          Also searched for filename: {{ builtins_path_norm | basename }} under {{ project_dir }}.
          Fix: commit/push the builtins file into the repo and ensure the AWX Project is synced.
      when: builtins_resolved_path | length == 0

    # ----------------------------
    # Show what we resolved (SAFE)
    # ----------------------------
    - name: Debug resolved files (SAFE)
      ansible.builtin.debug:
        msg:
          - "Project dir: {{ project_dir }}"
          - "Manifest resolved path: {{ manifest_resolved_path }}"
          - "Builtins resolved path: {{ builtins_resolved_path }}"
      changed_when: false

    # ----------------------------
    # Load YAML files
    # ----------------------------
    - name: Load manifest YAML
      ansible.builtin.set_fact:
        manifest: "{{ lookup('ansible.builtin.file', manifest_resolved_path) | from_yaml }}"

    - name: Load Microsoft built-ins mapping YAML
      ansible.builtin.set_fact:
        ms_map: "{{ lookup('ansible.builtin.file', builtins_resolved_path) | from_yaml }}"

    # ----------------------------
    # Generate container SAS (same method as your working SAS playbook)
    # ----------------------------
    - name: Compute SAS expiry (UTC)
      ansible.builtin.command: >
        date -u -d "+{{ sas_valid_hours }} hours" +"%Y-%m-%dT%H:%MZ"
      register: sas_expiry
      changed_when: false

    - name: List storage account keys (ARM action)
      azure.azcollection.azure_rm_resource:
        api_version: "2023-01-01"
        method: POST
        resource_group: "{{ rg_name }}"
        provider: Storage
        resource_type: storageAccounts
        resource_name: "{{ sa_name }}"
        subresource:
          - type: listKeys
      register: sa_keys
      changed_when: false

    - name: Extract primary key (safe)
      ansible.builtin.set_fact:
        sa_key: "{{ sa_keys.response['keys'][0]['value'] }}"
      no_log: true

    - name: Generate container SAS (read+list) using account key
      ansible.builtin.command: >
        az storage container generate-sas
        --account-name {{ sa_name }}
        --account-key {{ sa_key }}
        --name {{ container_name }}
        --permissions rl
        --expiry {{ sas_expiry.stdout }}
        --https-only
        -o tsv
      register: container_sas
      changed_when: false
      no_log: true

    - name: Build scripts base URL
      ansible.builtin.set_fact:
        scripts_base_url: "https://{{ sa_name }}.blob.core.windows.net/{{ container_name }}/{{ manifest.image_version }}"
      changed_when: false

    # ----------------------------
    # Build customize list
    # ----------------------------
    - name: Start customize list
      ansible.builtin.set_fact:
        customize: []
      changed_when: false

    - name: Add Microsoft must built-ins
      ansible.builtin.set_fact:
        customize: "{{ customize + [ (ms_map.ms_builtins[item] | combine(ps_defaults, recursive=true)) ] }}"
      loop: "{{ (manifest.microsoft_builtins.must | default({})).keys() | list }}"
      when:
        - manifest.microsoft_builtins is defined
        - manifest.microsoft_builtins.must is defined
        - (manifest.microsoft_builtins.must[item] | bool) == true
        - ms_map.ms_builtins[item] is defined
        - item != 'apply_windows_updates'


    - name: Add Microsoft optional built-ins
      ansible.builtin.set_fact:
        customize: "{{ customize + [ (ms_map.ms_builtins[item] | combine(ps_defaults, recursive=true)) ] }}"
      loop: "{{ (manifest.microsoft_builtins.optional | default({})).keys() | list }}"
      when:
        - manifest.microsoft_builtins is defined
        - manifest.microsoft_builtins.optional is defined
        - (manifest.microsoft_builtins.optional[item] | bool) == true
        - ms_map.ms_builtins[item] is defined

    - name: Add Windows Updates customizer if enabled in manifest
      ansible.builtin.set_fact:
        customize: "{{ customize + [ windows_update_customizer ] }}"
      when:
        - manifest.microsoft_builtins is defined
        - manifest.microsoft_builtins.must is defined
        - (manifest.microsoft_builtins.must.apply_windows_updates | default(false) | bool) == true

    - name: Add custom scripts from manifest (ordered) - adds SAS (hidden)
      ansible.builtin.set_fact:
        customize: >-
          {{
            customize + [
              {
                'type': 'PowerShell',
                'name': (item.name | regex_replace('[^A-Za-z0-9\\-]', '-') ),
                'scriptUri': (scripts_base_url ~ '/' ~ item.blob_path ~ '?' ~ container_sas.stdout),
                'runAsSystem': true,
                'runElevated': true
              }
            ]
          }}
      loop: "{{ manifest.custom_scripts | default([]) }}"
      when: item.blob_path is defined
      no_log: true

    # ----------------------------
    # Output preview (safe)
    # ----------------------------
    - name: Preview customize list (safe - no SAS)
      ansible.builtin.debug:
        msg:
          - "Customize steps count: {{ customize | length }}"
          - "Step names (order): {{ customize | map(attribute='name') | list }}"
      changed_when: false

    - name: Write customize JSON to /tmp for inspection (runner)
      ansible.builtin.copy:
        dest: "/tmp/aib-customize-{{ manifest.customer | lower }}-{{ manifest.image_version }}.json"
        content: "{{ customize | to_nice_json }}"
      changed_when: false
      no_log: true
