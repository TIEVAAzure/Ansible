---
# ============================================================================
# Playbook: AVD - Create AIB User Assigned Managed Identity (UAMI)
# ============================================================================
# Purpose
#   - Creates (or ensures) the UAMI used by Azure Image Builder.
#   - Assigns RBAC on staging RG + image definition for publishing.
# Notes
#   - Standard vars already used in this playbook.
# ============================================================================
# ============================================================================
# Playbook: AVD - Create AIB User Assigned Managed Identity (UAMI)
# Version: v2 (standardised variables + corrected scopes)
# ============================================================================
# What this playbook does
# -----------------------
# - Creates (or ensures) a User Assigned Managed Identity (UAMI)
# - Assigns RBAC so Azure Image Builder (AIB) can:
#     * Create temporary build resources in a staging resource group
#     * Publish image versions to a specific Azure Compute Gallery image definition
#
# Important separation of responsibilities
# ----------------------------------------
# - This UAMI is used by AIB *inside Azure* when running the image build
# - It is NOT the identity AWX uses to authenticate to Azure
#   (AWX uses its own Azure credential / managed identity / service principal)
#
# When this should run
# --------------------
# - Once per environment (dev/test/prod), or
# - Whenever you change gallery, image definition, or staging RG scopes
#
# Expected RBAC outcome
# ---------------------
# - Role assignment on the staging RG (Contributor by default)
# - Role assignment on the image definition scope in the Compute Gallery
#
# Notes
# -----
# - Role assignment tasks ignore errors to allow safe re-runs
# - Subscription context is taken from the AWX Azure credential
#   (AZURE_SUBSCRIPTION_ID environment variable)
# ============================================================================
- hosts: localhost
  gather_facts: false

  vars:
    # ------------------------------------------------------------
    # Core identity settings
    # ------------------------------------------------------------
    # Resource group where the UAMI object itself will live
    identity_rg: ""
    # Azure region
    location: "uksouth"
    # Name of the User Assigned Managed Identity
    uami_name: ""

    # ------------------------------------------------------------
    # Azure Image Builder build context
    # ------------------------------------------------------------
    # Resource group used by AIB for temporary build resources
    staging_rg: ""

    # ------------------------------------------------------------
    # Azure Compute Gallery target
    # ------------------------------------------------------------
    # Resource group containing the Compute Gallery
    gallery_rg: ""
    # Compute Gallery name
    gallery_name: ""
    # Image Definition name within the gallery
    image_definition_name: ""

    # ------------------------------------------------------------
    # RBAC configuration
    # ------------------------------------------------------------
    # Role assigned to the UAMI (Contributor is simplest for demo)
    aib_role_name: "Contributor"

  tasks:
    - name: Create or update User Assigned Managed Identity
      command: >
        az identity create
        --name {{ uami_name }}
        --resource-group {{ identity_rg }}
        --location {{ location }}
      register: uami_result
      changed_when: "'clientId' in uami_result.stdout"

    - name: Get UAMI principalId
      command: >
        az identity show
        --name {{ uami_name }}
        --resource-group {{ identity_rg }}
        --query principalId -o tsv
      register: uami_principal
      changed_when: false

    - name: Build staging RG scope
      set_fact:
        staging_scope: "/subscriptions/{{ lookup('env','AZURE_SUBSCRIPTION_ID') }}/resourceGroups/{{ staging_rg }}"

    - name: Build image definition scope
      set_fact:
        imgdef_scope: "/subscriptions/{{ lookup('env','AZURE_SUBSCRIPTION_ID') }}/resourceGroups/{{ gallery_rg }}/providers/Microsoft.Compute/galleries/{{ gallery_name }}/images/{{ image_definition_name }}"

    - name: Assign role on staging RG (AIB build permissions)
      command: >
        az role assignment create
        --assignee-object-id {{ uami_principal.stdout }}
        --assignee-principal-type ServicePrincipal
        --role {{ aib_role_name }}
        --scope {{ staging_scope }}
      ignore_errors: true

    - name: Assign role on image definition (publish image versions)
      command: >
        az role assignment create
        --assignee-object-id {{ uami_principal.stdout }}
        --assignee-principal-type ServicePrincipal
        --role {{ aib_role_name }}
        --scope {{ imgdef_scope }}
      ignore_errors: true
