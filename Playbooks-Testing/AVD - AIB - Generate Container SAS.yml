---
- name: AIB - Generate container SAS (test)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    rg_name: "{{ rg_name }}"
    sa_name: "{{ sa_name }}"
    container_name: "{{ container_name }}"
    sas_valid_hours: 24

  tasks:
    - name: Compute SAS expiry (UTC)
      ansible.builtin.command: >
        date -u -d "+{{ sas_valid_hours }} hours" +"%Y-%m-%dT%H:%MZ"
      register: sas_expiry
      changed_when: false

    - name: List storage account keys (ARM action)
      azure.azcollection.azure_rm_resource:
        api_version: "2023-01-01"
        method: POST
        resource_group: "{{ rg_name }}"
        provider: Storage
        resource_type: storageAccounts
        resource_name: "{{ sa_name }}"
        subresource:
          - type: listKeys
      register: sa_keys

    - name: Extract primary key
      ansible.builtin.set_fact:
        sa_key: "{{ sa_keys.response.keys[0].value }}"
      no_log: true

    - name: Generate container SAS (read+list) using account key
      ansible.builtin.command: >
        az storage container generate-sas
        --account-name {{ sa_name }}
        --account-key {{ sa_key }}
        --name {{ container_name }}
        --permissions rl
        --expiry {{ sas_expiry.stdout }}
        --https-only
        -o tsv
      register: container_sas
      changed_when: false
      no_log: true

    - name: Show SAS expiry only (safe)
      ansible.builtin.debug:
        msg:
          - "SAS expiry (UTC): {{ sas_expiry.stdout }}"
          - "Generated SAS token: (hidden)"
