---
- name: AIB - Generate container SAS (test)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    rg_name: "{{ rg_name }}"
    sa_name: "{{ sa_name }}"
    container_name: "{{ container_name }}"
    sas_valid_hours: 24

  tasks:
    - name: Compute SAS expiry (UTC)
      ansible.builtin.command: >
        date -u -d "+{{ sas_valid_hours }} hours" +"%Y-%m-%dT%H:%MZ"
      register: sas_expiry
      changed_when: false

    # ARM action: Microsoft.Storage/storageAccounts/listKeys
    - name: List storage account keys (ARM action)
      azure.azcollection.azure_rm_resource:
        api_version: "2023-01-01"
        method: POST
        resource_group: "{{ rg_name }}"
        provider: Storage
        resource_type: storageAccounts
        resource_name: "{{ sa_name }}"
        subresource:
          - type: listKeys
      register: sa_keys
      changed_when: false

    # SAFE debug: shows only the shape, never the key values
    - name: Debug listKeys response shape (SAFE - no secrets)
      ansible.builtin.debug:
        msg:
          - "sa_keys.response keys = {{ (sa_keys.response | default({})).keys() | list }}"
          - "Has response.keys? {{ (sa_keys.response.keys is defined) | default(false) }}"
          - "Has response.value? {{ (sa_keys.response.value is defined) | default(false) }}"
          - "Has response.properties? {{ (sa_keys.response.properties is defined) | default(false) }}"
      changed_when: false

    # Try common shapes. We keep this task secret because it sets sa_key.
    - name: Extract primary key (supports common response shapes)
      ansible.builtin.set_fact:
        sa_key: >-
          {{
            (sa_keys.response.keys[0].value)
            if (sa_keys.response is defined and sa_keys.response.keys is defined and (sa_keys.response.keys | length) > 0)
            else
            (sa_keys.response.value[0].value)
            if (sa_keys.response is defined and sa_keys.response.value is defined and (sa_keys.response.value | length) > 0)
            else
            (sa_keys.response.properties.keys[0].value)
            if (sa_keys.response is defined and sa_keys.response.properties is defined and sa_keys.response.properties.keys is defined and (sa_keys.response.properties.keys | length) > 0)
            else
            ''
          }}
      no_log: true

    - name: Fail if sa_key could not be extracted
      ansible.builtin.fail:
        msg: "Could not extract storage account key from listKeys response. Check sa_keys.response shape."
      when: sa_key | length == 0

    - name: Generate container SAS (read+list) using account key
      ansible.builtin.command: >
        az storage container generate-sas
        --account-name {{ sa_name }}
        --account-key {{ sa_key }}
        --name {{ container_name }}
        --permissions rl
        --expiry {{ sas_expiry.stdout }}
        --https-only
        -o tsv
      register: container_sas
      changed_when: false
      no_log: true

    - name: Show SAS expiry only (safe)
      ansible.builtin.debug:
        msg:
          - "SAS expiry (UTC): {{ sas_expiry.stdout }}"
          - "Generated SAS token: (hidden)"
      changed_when: false
