---
- name: Step 2 - Upload AIB scripts to customer storage container (optional folders)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    rg_name: "CUSTOMER-RG"
    sa_name: "customerstorageacct"
    container_name: "aib-scripts"

    customer: "IMS"
    image_version: "2026-Q1"
    blob_prefix: "{{ image_version }}"

    # Repo root (adjust if your playbook lives elsewhere)
    repo_root: "{{ lookup('env','AWX_PROJECT_DIR') | default(playbook_dir ~ '/..', true) | realpath }}"

    # Candidate folders (some may not exist for some customers)
    candidate_dirs:
      - "{{ repo_root }}/AVD-Scripts/Generic-Scripts"
      - "{{ repo_root }}/AVD-Scripts/Applications"
      - "{{ repo_root }}/AVD-Scripts/Customer/{{ customer }}"

  tasks:
    - name: Debug repo paths (temporary)
      ansible.builtin.debug:
      msg:
        - "playbook_dir={{ playbook_dir }}"
        - "repo_root={{ repo_root }}"
        - "candidate_dirs={{ candidate_dirs }}"

    - name: Check which candidate folders exist
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ candidate_dirs }}"
      register: dir_stats

    - name: Build list of existing folders
      ansible.builtin.set_fact:
        include_dirs: "{{ dir_stats.results | selectattr('stat.exists') | map(attribute='item') | list }}"

    - name: Fail if no script folders exist
      ansible.builtin.fail:
        msg: "None of the script folders exist for customer={{ customer }}. Checked: {{ candidate_dirs }}"
      when: include_dirs | length == 0

    - name: Find all PowerShell scripts under existing folders
      ansible.builtin.find:
        paths: "{{ include_dirs }}"
        patterns: "*.ps1"
        recurse: true
        file_type: file
      register: found_scripts

    - name: Fail if no scripts found in existing folders
      ansible.builtin.fail:
        msg: "No .ps1 scripts found under: {{ include_dirs }}"
      when: found_scripts.matched | int == 0

    - name: Upload scripts (preserve paths relative to repo_root/AVD-Scripts)
      azure_rm_storageblob:
        resource_group: "{{ rg_name }}"
        storage_account_name: "{{ sa_name }}"
        container: "{{ container_name }}"
        blob: >-
          {{ blob_prefix }}/{{ item.path
            | regex_replace('^' ~ repo_root ~ '/AVD-Scripts/', '') }}
        src: "{{ item.path }}"
        state: present
        force: true
      loop: "{{ found_scripts.files }}"

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "Existing folders used: {{ include_dirs }}"
          - "Uploaded {{ found_scripts.matched }} scripts"
          - "Base URL: https://{{ sa_name }}.blob.core.windows.net/{{ container_name }}/{{ blob_prefix }}/"
