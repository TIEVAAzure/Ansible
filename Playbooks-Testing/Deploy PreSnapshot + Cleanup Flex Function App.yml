---
- name: Deploy PreSnapshot + Cleanup Flex Function App
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # These will usually be overridden by the AWX survey
    deploy_sub_id: "27459e10-b37a-4b3b-9fa8-12f226dacd30"
    rg_name: "rg-presnapshot-mg-001"
    location: "uksouth"
    func_name: "fa-presnapcleanup-mg-001"
    storage_name: "stpresnapchsuks010tieva"

    # Multiline text in survey (one sub per line). If empty, defaults to deploy_sub_id.
    target_subscriptions: |
      3175995f-faf4-467e-8c38-ea866d1c9cdd
      4b944335-f142-4bb7-8bd6-8e868318c401
      a2274ccd-57b8-4d72-a94a-c38a235cf56e
      df82ae5c-8de4-4e5d-a976-a75d56fc3b9c
      27459e10-b37a-4b3b-9fa8-12f226dacd30

    # ZIP with both functions
    zip_url: "https://github.com/TIEVAAzure/Azure-Managed-Service/raw/refs/heads/main/PatchFunctionApp/Pre-SnapCleanup-Func_v2.2.zip"
    local_zip_name: "Pre-SnapCleanup-Func_fixed.zip"

    # Cleanup defaults (can also come from survey)
    cleanup_subscriptions: ""
    cleanup_resource_groups: ""
    cleanup_safety_minutes: "5"
    cleanup_max_deletes_per_run: "0"   # 0 = no limit
    cleanup_dry_run: "false"           # "true" or "false"

    # LogicMonitor values – default from environment, survey can override
    lm_auth: "{{ lookup('env', 'LM_AUTH') | default('', true) }}"
    lm_company: "{{ lookup('env', 'LM_COMPANY') | default('', true) }}"
    lm_domain_name: "{{ lookup('env', 'LM_DOMAIN_NAME') | default('logicmonitor.com', true) }}"
    lm_tenant_id: "{{ lookup('env', 'LM_TENANT_ID') | default('', true) }}"
    lm_sdt_minutes: "{{ lookup('env', 'LM_SDT_MINUTES') | default('120', true) }}"

  tasks:
    - name: Build list of target subscriptions (fallback to deploy_sub_id)
      set_fact:
        target_subscriptions_list: >-
          {{
            (target_subscriptions.splitlines()
              | map('trim')
              | reject('equalto','')
              | list)
            if target_subscriptions is defined and target_subscriptions | trim != ''
            else [ deploy_sub_id ]
          }}

    - name: Show target subscriptions (debug)
      debug:
        msg: "Target subscriptions: {{ target_subscriptions_list }}"

    - name: Set deployment subscription
      ansible.builtin.command:
        cmd: az account set --subscription {{ deploy_sub_id }}

    - name: Create resource group (idempotent)
      ansible.builtin.command:
        cmd: >
          az group create
          --name {{ rg_name }}
          --location {{ location }}
      register: rg_create

    - name: Debug RG create result
      debug:
        var: rg_create.stdout

    - name: Create storage account (idempotent)
      ansible.builtin.command:
        cmd: >
          az storage account create
          --name {{ storage_name }}
          --location {{ location }}
          --resource-group {{ rg_name }}
          --sku Standard_LRS
          --allow-blob-public-access false
      register: sa_create

    - name: Debug storage account result
      debug:
        var: sa_create.stdout

    - name: Create Flex Consumption PowerShell Function App (idempotent)
      ansible.builtin.command:
        cmd: >
          az functionapp create
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          --storage-account {{ storage_name }}
          --flexconsumption-location {{ location }}
          --runtime powershell
          --runtime-version 7.4
          -o json
      register: fa_create
      failed_when: false  # it may already exist

    - name: Show functionapp create output
      debug:
        var: fa_create.stdout

    - name: Enable system-assigned managed identity
      ansible.builtin.command:
        cmd: >
          az functionapp identity assign
          --name {{ func_name }}
          --resource-group {{ rg_name }}
          -o json
      register: identity_assign

    - name: Parse principalId from identity assignment
      set_fact:
        principal_id: "{{ (identity_assign.stdout | from_json).principalId }}"
      failed_when: principal_id is not defined or principal_id | length == 0

    - name: Show principal ID
      debug:
        msg: "Managed identity principalId: {{ principal_id }}"

    - name: Assign Contributor on target subscriptions
      ansible.builtin.command:
        cmd: >
          az role assignment create
          --assignee-object-id {{ principal_id }}
          --assignee-principal-type ServicePrincipal
          --role Contributor
          --scope /subscriptions/{{ item }}
      loop: "{{ target_subscriptions_list }}"
      register: role_results
      failed_when: false  # some may already exist

    - name: Show role assignment results
      debug:
        var: role_results.results

    - name: Download ZIP package
      ansible.builtin.get_url:
        url: "{{ zip_url }}"
        dest: "/tmp/{{ local_zip_name }}"
        mode: '0644'
      register: zip_download

    - name: Verify ZIP exists
      ansible.builtin.stat:
        path: "/tmp/{{ local_zip_name }}"
      register: zip_stat

    - name: Fail if ZIP download failed
      ansible.builtin.fail:
        msg: "ZIP download failed; file not found at /tmp/{{ local_zip_name }}"
      when: not zip_stat.stat.exists

    - name: Deploy ZIP to Function App via config-zip
      ansible.builtin.command:
        cmd: >
          az functionapp deployment source config-zip
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          --src /tmp/{{ local_zip_name }}
      register: deploy_zip

    - name: Show deployment output
      debug:
        var: deploy_zip.stdout

    - name: Configure cleanup + LogicMonitor app settings
      ansible.builtin.shell: >
        az functionapp config appsettings set
        --name {{ func_name }}
        --resource-group {{ rg_name }}
        --settings
          Cleanup_Subscriptions={{ cleanup_subscriptions }}
          Cleanup_ResourceGroups={{ cleanup_resource_groups }}
          Cleanup_SafetyMinutes={{ cleanup_safety_minutes }}
          Cleanup_MaxDeletesPerRun={{ cleanup_max_deletes_per_run }}
          Cleanup_DryRun={{ cleanup_dry_run }}
          LM_AUTH=$LM_AUTH
          LM_COMPANY=$LM_COMPANY
          LM_DOMAIN_NAME=$LM_DOMAIN_NAME
          LM_TENANT_ID=$LM_TENANT_ID
          LM_SDT_MINUTES=$LM_SDT_MINUTES
      environment:
        LM_AUTH: "{{ lm_auth }}"
        LM_COMPANY: "{{ lm_company }}"
        LM_DOMAIN_NAME: "{{ lm_domain_name }}"
        LM_TENANT_ID: "{{ lm_tenant_id }}"
        LM_SDT_MINUTES: "{{ lm_sdt_minutes }}"
      no_log: true  # hide secrets in AWX logs

    - name: Remove legacy WEBSITE_RUN_FROM_PACKAGE and FUNCTIONS_WORKER_RUNTIME (if present)
      ansible.builtin.command:
        cmd: >
          az functionapp config appsettings delete
          --name {{ func_name }}
          --resource-group {{ rg_name }}
          --setting-names WEBSITE_RUN_FROM_PACKAGE FUNCTIONS_WORKER_RUNTIME
          --yes
      register: appsettings_delete
      failed_when: false  # ok if they don't exist

    - name: List functions in the app
      ansible.builtin.command:
        cmd: >
          az functionapp function list
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          -o table
      register: func_list

    - name: Show functions
      debug:
        var: func_list.stdout
---
- name: Deploy PreSnapshot + Cleanup Flex Function App
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # These will usually be overridden by the AWX survey
    deploy_sub_id: "27459e10-b37a-4b3b-9fa8-12f226dacd30"
    rg_name: "rg-presnapshot-mg-001"
    location: "uksouth"
    func_name: "fa-presnapcleanup-mg-001"
    storage_name: "stpresnapchsuks010tieva"

    # Multiline text in survey (one sub per line). If empty, defaults to deploy_sub_id.
    target_subscriptions: |
      3175995f-faf4-467e-8c38-ea866d1c9cdd
      4b944335-f142-4bb7-8bd6-8e868318c401
      a2274ccd-57b8-4d72-a94a-c38a235cf56e
      df82ae5c-8de4-4e5d-a976-a75d56fc3b9c
      27459e10-b37a-4b3b-9fa8-12f226dacd30

    # ZIP with both functions
    zip_url: "https://github.com/TIEVAAzure/Azure-Managed-Service/raw/refs/heads/main/PatchFunctionApp/Pre-SnapCleanup-Func_v2.2.zip"
    local_zip_name: "Pre-SnapCleanup-Func_fixed.zip"

    # Cleanup defaults (can also come from survey)
    cleanup_subscriptions: ""
    cleanup_resource_groups: ""
    cleanup_safety_minutes: "5"
    cleanup_max_deletes_per_run: "0"   # 0 = no limit
    cleanup_dry_run: "false"           # "true" or "false"

    # LogicMonitor values – default from environment, survey can override
    lm_auth: "{{ lookup('env', 'LM_AUTH') | default('', true) }}"
    lm_company: "{{ lookup('env', 'LM_COMPANY') | default('', true) }}"
    lm_domain_name: "{{ lookup('env', 'LM_DOMAIN_NAME') | default('logicmonitor.com', true) }}"
    lm_tenant_id: "{{ lookup('env', 'LM_TENANT_ID') | default('', true) }}"
    lm_sdt_minutes: "{{ lookup('env', 'LM_SDT_MINUTES') | default('120', true) }}"

  tasks:
    - name: Build list of target subscriptions (fallback to deploy_sub_id)
      set_fact:
        target_subscriptions_list: >-
          {{
            (target_subscriptions.splitlines()
              | map('trim')
              | reject('equalto','')
              | list)
            if target_subscriptions is defined and target_subscriptions | trim != ''
            else [ deploy_sub_id ]
          }}

    - name: Show target subscriptions (debug)
      debug:
        msg: "Target subscriptions: {{ target_subscriptions_list }}"

    - name: Set deployment subscription
      ansible.builtin.command:
        cmd: az account set --subscription {{ deploy_sub_id }}

    - name: Create resource group (idempotent)
      ansible.builtin.command:
        cmd: >
          az group create
          --name {{ rg_name }}
          --location {{ location }}
      register: rg_create

    - name: Debug RG create result
      debug:
        var: rg_create.stdout

    - name: Create storage account (idempotent)
      ansible.builtin.command:
        cmd: >
          az storage account create
          --name {{ storage_name }}
          --location {{ location }}
          --resource-group {{ rg_name }}
          --sku Standard_LRS
          --allow-blob-public-access false
      register: sa_create

    - name: Debug storage account result
      debug:
        var: sa_create.stdout

    - name: Create Flex Consumption PowerShell Function App (idempotent)
      ansible.builtin.command:
        cmd: >
          az functionapp create
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          --storage-account {{ storage_name }}
          --flexconsumption-location {{ location }}
          --runtime powershell
          --runtime-version 7.4
          -o json
      register: fa_create
      failed_when: false  # it may already exist

    - name: Show functionapp create output
      debug:
        var: fa_create.stdout

    - name: Enable system-assigned managed identity
      ansible.builtin.command:
        cmd: >
          az functionapp identity assign
          --name {{ func_name }}
          --resource-group {{ rg_name }}
          -o json
      register: identity_assign

    - name: Parse principalId from identity assignment
      set_fact:
        principal_id: "{{ (identity_assign.stdout | from_json).principalId }}"
      failed_when: principal_id is not defined or principal_id | length == 0

    - name: Show principal ID
      debug:
        msg: "Managed identity principalId: {{ principal_id }}"

    - name: Assign Contributor on target subscriptions
      ansible.builtin.command:
        cmd: >
          az role assignment create
          --assignee-object-id {{ principal_id }}
          --assignee-principal-type ServicePrincipal
          --role Contributor
          --scope /subscriptions/{{ item }}
      loop: "{{ target_subscriptions_list }}"
      register: role_results
      failed_when: false  # some may already exist

    - name: Show role assignment results
      debug:
        var: role_results.results

    - name: Download ZIP package
      ansible.builtin.get_url:
        url: "{{ zip_url }}"
        dest: "/tmp/{{ local_zip_name }}"
        mode: '0644'
      register: zip_download

    - name: Verify ZIP exists
      ansible.builtin.stat:
        path: "/tmp/{{ local_zip_name }}"
      register: zip_stat

    - name: Fail if ZIP download failed
      ansible.builtin.fail:
        msg: "ZIP download failed; file not found at /tmp/{{ local_zip_name }}"
      when: not zip_stat.stat.exists

    - name: Deploy ZIP to Function App via config-zip
      ansible.builtin.command:
        cmd: >
          az functionapp deployment source config-zip
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          --src /tmp/{{ local_zip_name }}
      register: deploy_zip

    - name: Show deployment output
      debug:
        var: deploy_zip.stdout

    - name: Configure cleanup + LogicMonitor app settings
      ansible.builtin.shell: >
        az functionapp config appsettings set
        --name {{ func_name }}
        --resource-group {{ rg_name }}
        --settings
          Cleanup_Subscriptions={{ cleanup_subscriptions }}
          Cleanup_ResourceGroups={{ cleanup_resource_groups }}
          Cleanup_SafetyMinutes={{ cleanup_safety_minutes }}
          Cleanup_MaxDeletesPerRun={{ cleanup_max_deletes_per_run }}
          Cleanup_DryRun={{ cleanup_dry_run }}
          LM_AUTH=$LM_AUTH
          LM_COMPANY=$LM_COMPANY
          LM_DOMAIN_NAME=$LM_DOMAIN_NAME
          LM_TENANT_ID=$LM_TENANT_ID
          LM_SDT_MINUTES=$LM_SDT_MINUTES
      environment:
        LM_AUTH: "{{ lm_auth }}"
        LM_COMPANY: "{{ lm_company }}"
        LM_DOMAIN_NAME: "{{ lm_domain_name }}"
        LM_TENANT_ID: "{{ lm_tenant_id }}"
        LM_SDT_MINUTES: "{{ lm_sdt_minutes }}"
      no_log: true  # hide secrets in AWX logs

    - name: Remove legacy WEBSITE_RUN_FROM_PACKAGE and FUNCTIONS_WORKER_RUNTIME (if present)
      ansible.builtin.command:
        cmd: >
          az functionapp config appsettings delete
          --name {{ func_name }}
          --resource-group {{ rg_name }}
          --setting-names WEBSITE_RUN_FROM_PACKAGE FUNCTIONS_WORKER_RUNTIME
          --yes
      register: appsettings_delete
      failed_when: false  # ok if they don't exist

    - name: List functions in the app
      ansible.builtin.command:
        cmd: >
          az functionapp function list
          --resource-group {{ rg_name }}
          --name {{ func_name }}
          -o table
      register: func_list

    - name: Show functions
      debug:
        var: func_list.stdout
