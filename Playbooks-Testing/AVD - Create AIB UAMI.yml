---
# ============================================================================
# Playbook: AVD - Create AIB User Assigned Managed Identity (UAMI)
# ============================================================================
# Purpose
#   - Creates (or ensures) the UAMI used by Azure Image Builder.
#   - Assigns RBAC on staging RG + image definition for publishing.
#
# Notes
#   - This version uses ONLY Ansible Azure modules (no Azure CLI dependency).
#   - Authentication is handled via AWX Azure Credential / environment variables.
#
# Required variables (Survey)
#   - identity_rg
#   - location
#   - uami_name
#   - staging_rg
#   - gallery_rg
#   - gallery_name
#   - image_definition_name
#   - aib_role_name
# ============================================================================

- name: AVD - Create AIB UAMI (Module-based)
  hosts: localhost
  connection: local
  gather_facts: false

  # --------------------------------------------------------------------------
  # Pre-flight validation (fail fast with clear messages)
  # --------------------------------------------------------------------------
  pre_tasks:
    - name: Validate required survey variables are provided
      ansible.builtin.assert:
        that:
          - identity_rg is defined and identity_rg | length > 0
          - location is defined and location | length > 0
          - uami_name is defined and uami_name | length > 0
          - staging_rg is defined and staging_rg | length > 0
          - gallery_rg is defined and gallery_rg | length > 0
          - gallery_name is defined and gallery_name | length > 0
          - image_definition_name is defined and image_definition_name | length > 0
          - aib_role_name is defined and aib_role_name | length > 0
        fail_msg: >
          Missing one or more required variables. Check your AWX Survey fields:
          identity_rg, location, uami_name, staging_rg, gallery_rg, gallery_name,
          image_definition_name, aib_role_name.

    - name: Read subscription id from environment (AWX Azure Credential)
      ansible.builtin.set_fact:
        subscription_id: "{{ lookup('env', 'AZURE_SUBSCRIPTION_ID') | default('', true) }}"

    - name: Validate AZURE_SUBSCRIPTION_ID is available to the job
      ansible.builtin.assert:
        that:
          - subscription_id | length > 0
        fail_msg: >
          AZURE_SUBSCRIPTION_ID was not found in the job environment.
          Ensure your AWX Job Template has the correct Azure Credential attached.

  tasks:
    # ------------------------------------------------------------------------
    # 1) Create (or ensure) the User Assigned Managed Identity (UAMI)
    # ------------------------------------------------------------------------
    - name: Create or update User Assigned Managed Identity (UAMI)
      azure.azcollection.azure_rm_managedidentity:
        resource_group: "{{ identity_rg }}"
        name: "{{ uami_name }}"
        location: "{{ location }}"
        state: present
      register: uami_result

    # ------------------------------------------------------------------------
    # 2) Capture the principal_id for RBAC assignments
    #    - Different module versions return slightly different structures,
    #      so we safely try multiple paths.
    # ------------------------------------------------------------------------
    - name: Extract UAMI principal_id from module result
      ansible.builtin.set_fact:
        uami_principal_id: >-
          {{
            (uami_result.managed_identity.principal_id
              | default(uami_result.state.principal_id, true)
              | default(uami_result.response.principal_id, true)
              | default(uami_result.principal_id, true)
              | default('', true))
          }}

    - name: Validate UAMI principal_id was retrieved successfully
      ansible.builtin.assert:
        that:
          - uami_principal_id | length > 0
        fail_msg: >
          Could not determine the UAMI principal_id from the module output.
          Enable verbose logging in AWX and review uami_result.

    # ------------------------------------------------------------------------
    # 3) Build RBAC scopes
    #    - Staging scope: RG-level permissions for AIB temp resources.
    #    - Image definition scope: permission to publish image versions.
    # ------------------------------------------------------------------------
    - name: Build staging RG scope
      ansible.builtin.set_fact:
        staging_scope: "/subscriptions/{{ subscription_id }}/resourceGroups/{{ staging_rg }}"

    - name: Build Image Definition scope (gallery -> image definition)
      ansible.builtin.set_fact:
        imgdef_scope: >-
          /subscriptions/{{ subscription_id }}/resourceGroups/{{ gallery_rg }}
          /providers/Microsoft.Compute/galleries/{{ gallery_name }}
          /images/{{ image_definition_name }}

    # ------------------------------------------------------------------------
    # 4) Assign RBAC roles
    #    - If the role assignment already exists, the module remains idempotent.
    #
    # IMPORTANT
    #   - Your AWX Service Principal must be allowed to create role assignments:
    #       * Owner OR User Access Administrator (or custom with roleAssignments/write)
    # ------------------------------------------------------------------------
    - name: Assign role on AIB staging resource group
      azure.azcollection.azure_rm_roleassignment:
        scope: "{{ staging_scope }}"
        assignee_object_id: "{{ uami_principal_id }}"
        role_definition_name: "{{ aib_role_name }}"
        state: present

    - name: Assign role on image definition (publish image versions)
      azure.azcollection.azure_rm_roleassignment:
        scope: "{{ imgdef_scope | regex_replace('\\s+', '') }}"
        assignee_object_id: "{{ uami_principal_id }}"
        role_definition_name: "{{ aib_role_name }}"
        state: present

    # ------------------------------------------------------------------------
    # 5) Output summary (useful in AWX job output)
    # ------------------------------------------------------------------------
    - name: Summary
      ansible.builtin.debug:
        msg:
          - "UAMI ensured: {{ uami_name }} (RG: {{ identity_rg }}, location: {{ location }})"
          - "UAMI principal_id: {{ uami_principal_id }}"
          - "RBAC applied: role='{{ aib_role_name }}'"
          - "Staging scope: {{ staging_scope }}"
          - "Image definition scope: {{ imgdef_scope | regex_replace('\\s+', '') }}"
