---
# -------------------------------------------------------------------
# STEP 2 (DEV): Create AIB User Assigned Managed Identity (UAMI)
# and assign RBAC so AIB can:
#  - create build resources (Contributor on RG)
#  - publish image versions (Contributor on image definition)
#
# Why azure_rm_resource?
# - azure_rm_managedidentity is not present in your EE
# - azure_rm_resource is present and can create the UAMI directly
# -------------------------------------------------------------------

- name: Create AIB UAMI + RBAC (DEV)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - azure.azcollection

  vars:
    # Where the identity will live
    rg_name: "rg-mg-learn-uksouth-001"
    location: "uksouth"

    # Identity name (dashes are fine)
    uami_name: "uami-aib-avd-dev"

    # Compute Gallery details created in Step 1
    gallery_name: "acg_avd_dev"
    image_definition_name: "avd_win11ms_standard"
    gallery_rg_name: "{{ rg_name }}"

    # API version for Managed Identity resources
    api_version_uami: "2023-01-31"

  tasks:
    # ---------------------------------------------------------------
    # TASK 1: Create the User Assigned Managed Identity
    #
    # NOTE:
    # Provider format can vary between environments. For azure_rm_resource
    # we use the provider WITHOUT "Microsoft." to avoid the double-prefix
    # issue you hit earlier.
    #
    # Resource created:
    # Microsoft.ManagedIdentity/userAssignedIdentities/<uami_name>
    # ---------------------------------------------------------------
    - name: Create/Ensure UAMI exists (via azure_rm_resource)
      azure_rm_resource:
        resource_group: "{{ rg_name }}"
        provider: "ManagedIdentity"
        resource_type: "userAssignedIdentities"
        resource_name: "{{ uami_name }}"
        api_version: "{{ api_version_uami }}"
        body:
          location: "{{ location }}"
      register: uami_out

    # ---------------------------------------------------------------
    # TASK 2: Extract principalId and resourceId for RBAC + next steps
    # ---------------------------------------------------------------
    - name: Extract UAMI IDs
      ansible.builtin.set_fact:
        uami_resource_id: "{{ uami_out.response.id }}"
        uami_principal_id: "{{ uami_out.response.properties.principalId }}"
        subscription_id: "{{ (uami_out.response.id.split('/'))[2] }}"

    # ---------------------------------------------------------------
    # TASK 3: Build scopes
    # - RG scope: allow AIB to create temporary build resources
    # - Image definition scope: allow AIB to publish image versions
    # ---------------------------------------------------------------
    - name: Build RBAC scopes
      ansible.builtin.set_fact:
        rg_scope: "/subscriptions/{{ subscription_id }}/resourceGroups/{{ rg_name }}"
        imgdef_scope: "/subscriptions/{{ subscription_id }}/resourceGroups/{{ gallery_rg_name }}/providers/Microsoft.Compute/galleries/{{ gallery_name }}/images/{{ image_definition_name }}"

    # ---------------------------------------------------------------
    # TASK 4: Contributor on RG (AIB build permissions)
    # Older azcollection requires assignee_object_id + role_definition_id
    # ---------------------------------------------------------------
    - name: RBAC - Contributor on RG for AIB build operations
      azure_rm_roleassignment:
        scope: "{{ rg_scope }}"
        role_definition_id: "b24988ac-6180-42a0-ab88-20f7382dd24c"
        assignee_object_id: "{{ uami_principal_id }}"
        state: present

    # ---------------------------------------------------------------
    # TASK 5: Contributor on Image Definition (publish image versions)
    # ---------------------------------------------------------------
    - name: RBAC - Contributor on Image Definition
      azure_rm_roleassignment:
        scope: "{{ imgdef_scope }}"
        role_definition_id: "b24988ac-6180-42a0-ab88-20f7382dd24c"
        assignee_object_id: "{{ uami_principal_id }}"
        state: present

    # ---------------------------------------------------------------
    # TASK 6: Output for the next step (AIB template needs UAMI resourceId)
    # ---------------------------------------------------------------
    - name: Output UAMI details (save these)
      ansible.builtin.debug:
        msg:
          - "UAMI name: {{ uami_name }}"
          - "UAMI resource ID: {{ uami_resource_id }}"
          - "UAMI principal ID: {{ uami_principal_id }}"
          - "Subscription ID: {{ subscription_id }}"
